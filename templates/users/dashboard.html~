{% extends 'base.html' %}
{% load humanize %}
{% block page_title %}Mening Dashboard{% endblock %}

{% block extra_css %}
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }

.container { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Header */
.header {
  background: linear-gradient(135deg, #8b5cf6, #6366f1);
  color: white;
  padding: 24px;
  border-radius: 12px;
  margin-bottom: 24px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.header h1 { font-size: 28px; margin-bottom: 8px; font-weight: 700; }
.header-subtitle { font-size: 14px; opacity: 0.9; }

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-bottom: 20px;
}
.stat-item {
  background: linear-gradient(135deg, #fafafa, #ffffff);
  padding: 16px;
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  text-align: center;
}
.stat-label {
  font-size: 11px;
  color: #6b7280;
  font-weight: 600;
  text-transform: uppercase;
  margin-bottom: 8px;
}
.stat-value {
  font-size: 24px;
  font-weight: 700;
  line-height: 1;
}
.stat-value.phone { color: #10b981; }
.stat-value.accessory { color: #3b82f6; }
.stat-value.exchange { color: #f59e0b; }
.stat-value.profit { color: #8b5cf6; }

/* Charts */
.charts-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
  margin-top: 20px;
}
.chart-wrapper {
  background: white;
  padding: 20px;
  border-radius: 10px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.chart-title {
  font-size: 13px;
  font-weight: 700;
  color: #374151;
  margin-bottom: 12px;
  text-transform: uppercase;
}
.chart-canvas {
  position: relative;
  height: 300px;
}

@media (max-width: 1200px) {
  .charts-container { grid-template-columns: 1fr; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="header">
    <h1>Mening Statistikam</h1>
    <div class="header-subtitle">
      {{ month_names|get_item:current_month }} {{ current_year }} | {{ selected_shop.name }}
    </div>
  </div>

  {% if sellers_data %}
    {% with seller_data=sellers_data.0 %}

    <!-- OYLIK STATISTIKA -->
    <div class="stats-grid">
      <div class="stat-item">
        <div class="stat-label">Telefon Sotildi</div>
        <div class="stat-value phone">{{ seller_data.monthly.phone_count }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Aksessuar</div>
        <div class="stat-value accessory">{{ seller_data.monthly.accessory_count }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Almashtirish</div>
        <div class="stat-value exchange">{{ seller_data.monthly.exchange_count }}</div>
      </div>
      <div class="stat-item">
        <div class="stat-label">Jami Foyda</div>
        <div class="stat-value profit">
          ${{ seller_data.monthly.phone_profit|add:seller_data.monthly.exchange_profit|floatformat:0|intcomma }}
        </div>
      </div>
    </div>

    <!-- DIAGRAMMALAR -->
    <div class="charts-container">
      <div class="chart-wrapper">
        <div class="chart-title">📊 Kunlik Faollik</div>
        <div class="chart-canvas">
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
      <div class="chart-wrapper">
        <div class="chart-title">📈 Yillik O'sish</div>
        <div class="chart-canvas">
          <canvas id="yearlyChart"></canvas>
        </div>
      </div>
    </div>

    {% endwith %}
  {% endif %}
</div>

<!-- ⭐ Chart.js CDN - BODY TUGASHIDAN OLDIN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- ⭐ CHART SCRIPT - CDN DAN KEYIN -->
<script>
{% if sellers_data %}
{% with seller_data=sellers_data.0 %}
document.addEventListener('DOMContentLoaded', function() {
  // Kunlik Chart
  const dailyCtx = document.getElementById('dailyChart').getContext('2d');
  new Chart(dailyCtx, {
    type: 'line',
    data: {
      labels: Array.from({length: {{ seller_data.charts.daily_phone|length }}}, (_, i) => i + 1),
      datasets: [{
        label: 'Telefon',
        data: {{ seller_data.charts.daily_phone|safe }},
        borderColor: '#10b981',
        backgroundColor: 'rgba(16, 185, 129, 0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }, {
        label: 'Aksessuar',
        data: {{ seller_data.charts.daily_accessory|safe }},
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59, 130, 246, 0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  // Yillik Chart
  const yearlyCtx = document.getElementById('yearlyChart').getContext('2d');
  new Chart(yearlyCtx, {
    type: 'bar',
    data: {
      labels: ['Yan', 'Fev', 'Mar', 'Apr', 'May', 'Iyun', 'Iyul', 'Avg', 'Sen', 'Okt', 'Noy', 'Dek'],
      datasets: [{
        label: 'Telefon',
        data: {{ seller_data.charts.monthly_phone|safe }},
        backgroundColor: '#10b981',
      }, {
        label: 'Aksessuar',
        data: {{ seller_data.charts.monthly_accessory|safe }},
        backgroundColor: '#3b82f6',
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'top' }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
});
{% endwith %}
{% endif %}
</script>
{% endblock %}