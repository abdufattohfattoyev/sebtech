{% extends 'base.html' %}
{% load humanize %}
{% block page_title %}Kunlik Hisobot{% endblock %}

{% block extra_css %}
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Header */
.header {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 700; }
.header-date { font-size: 14px; opacity: 0.95; }
.nav { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
.nav a {
  padding: 10px 18px;
  background: rgba(255,255,255,0.15);
  border-radius: 8px;
  color: white;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}
.nav a:hover { background: rgba(255,255,255,0.25); }
.nav a.active { background: rgba(255,255,255,0.35); }

/* Filter */
.filter {
  background: white;
  padding: 18px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.filter-row {
  display: grid;
  grid-template-columns: 2fr 1fr auto auto;
  gap: 12px;
  align-items: end;
}
.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
  color: #374151;
}
.form-control, .form-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  transition: border 0.2s;
}
.form-control:focus, .form-select:focus {
  outline: none;
  border-color: #2563eb;
}
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-primary { background: #2563eb; color: white; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #6b7280; color: white; }
.btn-secondary:hover { background: #4b5563; }

/* Stats Container */
.stats-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}
.stats-section {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.stats-section-title {
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
  padding-bottom: 10px;
  border-bottom: 3px solid;
}
.stats-section-title.usd { border-color: #10b981; color: #10b981; }
.stats-section-title.uzs { border-color: #3b82f6; color: #3b82f6; }
.stats-section-title.cashflow { border-color: #f59e0b; color: #f59e0b; }
.stats-section-title.kassa-title { border-color: #10b981; color: #065f46; }

.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
.stats-grid-3 {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.stats-grid-4 {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
}
.stats-grid-5 {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
}

.stat {
  text-align: center;
  padding: 16px;
  background: linear-gradient(135deg, #f9fafb, #ffffff);
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  transition: transform 0.2s;
}
.stat:hover { transform: translateY(-2px); }
.stat-label {
  font-size: 11px;
  color: #6b7280;
  margin-bottom: 8px;
  font-weight: 600;
  text-transform: uppercase;
  line-height: 1.3;
}
.stat-value {
  font-size: 22px;
  font-weight: 700;
  line-height: 1;
  word-break: break-word;
}
.stat-value.usd { color: #10b981; }
.stat-value.uzs { color: #3b82f6; }
.stat-value.income { color: #10b981; }
.stat-value.expense { color: #dc2626; }
.stat-value.net { color: #8b5cf6; }
.stat-value.installment { color: #f59e0b; }
.stat-currency {
  font-size: 10px;
  color: #9ca3af;
  margin-top: 6px;
  font-weight: 500;
}

/* Kassa Section */
.kassa-section {
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
  border: 2px solid #10b981;
}
.kassa-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.kassa-stat {
  text-align: center;
  padding: 16px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.kassa-stat.highlight {
  border: 3px solid #10b981;
  background: linear-gradient(135deg, #ffffff, #f0fdf4);
}

/* Cash Flow Section */
.cashflow-section {
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  border: 2px solid #f59e0b;
}
.cashflow-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

/* Main */
.main {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
.card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.card-header {
  padding: 16px 20px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-bottom: 1px solid #e5e7eb;
  font-weight: 700;
  font-size: 14px;
}
.card-body { padding: 18px; }

/* Tabs */
.tabs { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.tab-btn {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  min-width: 100px;
  transition: all 0.2s;
}
.tab-btn:hover { background: #f9fafb; }
.tab-btn.active { background: #2563eb; color: white; border-color: #2563eb; }

.tab-pane { display: none; max-height: 520px; overflow-y: auto; }
.tab-pane.active { display: block; }

/* Sale Items */
.sale-item {
  padding: 14px;
  margin-bottom: 10px;
  background: #fafafa;
  border-left: 4px solid;
  border-radius: 8px;
  transition: all 0.2s;
}
.sale-item:hover { transform: translateX(3px); }
.sale-item.phone {
  border-left-color: #10b981;
  background: linear-gradient(135deg, #ecfdf5, #fafafa);
}
.sale-item.accessory {
  border-left-color: #3b82f6;
  background: linear-gradient(135deg, #eff6ff, #fafafa);
}
.sale-item.exchange {
  border-left-color: #f59e0b;
  background: linear-gradient(135deg, #fffbeb, #fafafa);
}

.sale-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
  gap: 8px;
}
.sale-title { font-weight: 700; font-size: 14px; color: #111827; }
.sale-time { font-size: 11px; color: #6b7280; font-weight: 500; }
.sale-price { font-weight: 700; font-size: 16px; }
.sale-price.usd { color: #10b981; }
.sale-price.uzs { color: #3b82f6; }

.sale-details { font-size: 12px; color: #4b5563; line-height: 1.6; }
.detail-row { margin-bottom: 4px; }
.detail-label { color: #6b7280; font-weight: 500; }

.sale-payment {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  margin-top: 10px;
}
.payment-badge {
  padding: 8px;
  background: white;
  border-radius: 6px;
  text-align: center;
  font-size: 11px;
  border: 1px solid #e5e7eb;
}
.payment-label {
  font-size: 9px;
  color: #6b7280;
  display: block;
  margin-bottom: 4px;
  font-weight: 600;
}
.payment-value { font-weight: 700; font-size: 12px; word-break: break-word; }
.payment-value.cash { color: #10b981; }
.payment-value.card { color: #3b82f6; }
.payment-value.installment { color: #f59e0b; }
.payment-value.debt { color: #dc2626; }
.payment-value.profit { color: #8b5cf6; }

/* Sellers */
.sellers { max-height: 550px; overflow-y: auto; }
.seller {
  padding: 14px;
  border-bottom: 1px solid #f3f4f6;
  cursor: pointer;
  transition: all 0.2s;
}
.seller:hover { background: #f9fafb; }
.seller-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.seller-left { display: flex; align-items: center; gap: 12px; }
.seller-rank {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #6b7280;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  flex-shrink: 0;
}
.seller-rank.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
.seller-rank.silver { background: linear-gradient(135deg, #e2e8f0, #94a3b8); }
.seller-rank.bronze { background: linear-gradient(135deg, #f59e0b, #d97706); }
.seller-name { font-weight: 700; font-size: 14px; color: #111827; }
.seller-right { text-align: right; }
.seller-amount { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
.seller-amount.usd { color: #10b981; }
.seller-count { font-size: 12px; color: #6b7280; font-weight: 500; }

/* Sotuvchi detallari */
.seller-details {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #e5e7eb;
}
.seller-detail-item {
  text-align: center;
  padding: 8px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}
.seller-detail-label {
  font-size: 9px;
  color: #6b7280;
  font-weight: 600;
  text-transform: uppercase;
  margin-bottom: 4px;
}
.seller-detail-value {
  font-size: 14px;
  font-weight: 700;
}
.seller-detail-value.phone { color: #10b981; }
.seller-detail-value.accessory { color: #3b82f6; }
.seller-detail-value.exchange { color: #f59e0b; }
.seller-detail-value.return { color: #dc2626; }

.empty {
  text-align: center;
  padding: 40px 20px;
  color: #9ca3af;
  font-size: 13px;
}

/* Print */
@media print {
  .filter, .nav, .btn { display: none !important; }
  .container { padding: 10px; }
  .card { page-break-inside: avoid; }
}

/* Responsive */
@media (max-width: 1024px) {
  .stats-container { grid-template-columns: 1fr; }
  .main { grid-template-columns: 1fr; }
  .stats-grid-5 { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 768px) {
  .stats-grid-5 { grid-template-columns: repeat(2, 1fr); }
  .seller-details { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 480px) {
  .stats-grid-5 { grid-template-columns: 1fr; }
  .seller-details { grid-template-columns: repeat(2, 1fr); }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="header">
    <h1>{{ selected_shop.name }}</h1>
    <div class="header-date">{{ selected_date|date:"d F Y, l" }}</div>
    <div class="nav">
      <a href="{% url 'reports:daily' %}?shop={{ selected_shop.id }}" class="active">Kunlik</a>
      <a href="{% url 'reports:monthly' %}?shop={{ selected_shop.id }}">Oylik</a>
      <a href="{% url 'reports:yearly' %}?shop={{ selected_shop.id }}">Yillik</a>
    </div>
  </div>

  <div class="filter">
    <form method="get">
      <div class="filter-row">
        <div class="form-group">
          <label>Do'kon</label>
          <select name="shop" class="form-select">
            {% for shop in shops %}
            <option value="{{ shop.id }}" {% if shop == selected_shop %}selected{% endif %}>{{ shop.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Sana</label>
          <input type="date" name="date" class="form-control" value="{{ selected_date|date:'Y-m-d' }}">
        </div>
        <button type="submit" class="btn btn-primary">Ko'rsat</button>
        <button type="button" class="btn btn-secondary" onclick="window.print()">Chop</button>
      </div>
    </form>
  </div>

  <!-- TELEFON VA AKSESSUAR -->
  <div class="stats-container">
    <div class="stats-section">
      <div class="stats-section-title usd">TELEFON (Dollar)</div>
      <div class="stats-grid">
        <div class="stat">
          <div class="stat-label">Jami Savdo</div>
          <div class="stat-value usd">${{ daily_stats.sales.phone_total_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Naqd</div>
          <div class="stat-value usd">${{ daily_stats.sales.phone_cash_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Karta</div>
          <div class="stat-value usd">${{ daily_stats.sales.phone_card_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Nasiya</div>
          <div class="stat-value installment">${{ daily_stats.sales.phone_credit_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Qarz</div>
          <div class="stat-value expense">${{ daily_stats.sales.phone_debt_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Soni</div>
          <div class="stat-value usd">{{ daily_stats.counts.phone|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
        <div class="stat">
          <div class="stat-label">Almashtirish</div>
          <div class="stat-value usd">{{ daily_stats.counts.exchange|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
        <div class="stat">
          <div class="stat-label">Foyda</div>
          <div class="stat-value usd">${{ daily_stats.profits.phone_profit_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
      </div>
    </div>

    <div class="stats-section">
      <div class="stats-section-title uzs">AKSESSUAR (So'm)</div>
      <div class="stats-grid">
        <div class="stat">
          <div class="stat-label">Jami Savdo</div>
          <div class="stat-value uzs">{{ daily_stats.sales.accessory_total_uzs|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Naqd</div>
          <div class="stat-value uzs">{{ daily_stats.sales.accessory_cash_uzs|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Karta</div>
          <div class="stat-value uzs">{{ daily_stats.sales.accessory_card_uzs|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Nasiya</div>
          <div class="stat-value installment">{{ daily_stats.sales.accessory_credit_uzs|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Qarz</div>
          <div class="stat-value expense">{{ daily_stats.sales.accessory_debt_uzs|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Soni</div>
          <div class="stat-value uzs">{{ daily_stats.counts.accessory|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
        <div class="stat">
          <div class="stat-label">Xarajat</div>
          <div class="stat-value expense">{{ daily_stats.expenses|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Foyda</div>
          <div class="stat-value uzs">{{ daily_stats.profits.accessory_profit_uzs|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CASH FLOW -->
  <div class="stats-container">
    <div class="stats-section cashflow-section">
      <div class="stats-section-title cashflow">CASH FLOW - DOLLAR</div>
      <div class="cashflow-grid">
        <div class="stat">
          <div class="stat-label">Kirim</div>
          <div class="stat-value income">${{ daily_stats.cashflow.usd.income|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Chiqim</div>
          <div class="stat-value expense">${{ daily_stats.cashflow.usd.expense|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Sof Balans</div>
          <div class="stat-value net">${{ daily_stats.cashflow.usd.net|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
      </div>
    </div>

    <div class="stats-section cashflow-section">
      <div class="stats-section-title cashflow">CASH FLOW - SO'M</div>
      <div class="cashflow-grid">
        <div class="stat">
          <div class="stat-label">Kirim</div>
          <div class="stat-value income">{{ daily_stats.cashflow.uzs.income|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Chiqim</div>
          <div class="stat-value expense">{{ daily_stats.cashflow.uzs.expense|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Sof Balans</div>
          <div class="stat-value net">{{ daily_stats.cashflow.uzs.net|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
      </div>
    </div>
  </div>

  <!-- KASSADA NAQD -->
  <div class="stats-container">
    <div class="stats-section kassa-section">
      <div class="stats-section-title kassa-title">KASSADA NAQD</div>
      <div class="kassa-grid">
        <div class="kassa-stat highlight">
          <div class="stat-label">Dollar (Naqd)</div>
          <div class="stat-value usd">${{ daily_stats.sales.phone_cash_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="kassa-stat highlight">
          <div class="stat-label">So'm (Naqd - Xarajat)</div>
          <div class="stat-value uzs">{{ daily_stats.net_cash_uzs|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="kassa-stat">
          <div class="stat-label">Teng Almashtirish</div>
          <div class="stat-value" style="color: #f59e0b; font-size: 24px;">{{ daily_stats.cashflow.details.exchange_equal|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="card">
      <div class="card-header">Sotuvlar Tafsiloti</div>
      <div class="card-body">
        <div class="tabs">
          <button class="tab-btn active" onclick="showTab('phones')">Telefonlar ({{ daily_stats.counts.phone|default:0 }})</button>
          <button class="tab-btn" onclick="showTab('accessories')">Aksessuarlar ({{ daily_stats.counts.accessory|default:0 }})</button>
          <button class="tab-btn" onclick="showTab('exchanges')">Almashtirish ({{ daily_stats.counts.exchange|default:0 }})</button>
        </div>

        <div id="phones-tab" class="tab-pane active">
          {% if daily_stats.sales_data.phone_sales %}
            {% for sale in daily_stats.sales_data.phone_sales %}
            <div class="sale-item phone">
              <div class="sale-header">
                <div>
                  <div class="sale-title">{{ sale.phone.phone_model }} {{ sale.phone.memory_size }}</div>
                  <div class="sale-time">{{ sale.created_at|date:"H:i" }}</div>
                </div>
                <div class="sale-price usd">${{ sale.sale_price|floatformat:0|intcomma }}</div>
              </div>
              <div class="sale-details">
                  <div class="detail-row">
                      <span class="detail-label">Mijoz:</span> {{ sale.customer.name }}
                  </div>
                  <div class="detail-row">
                      <span class="detail-label">Sotuvchi:</span> {{ sale.salesman.get_full_name|default:sale.salesman.username }}
                  </div>
                  <div class="detail-row">
                      <span class="detail-label">IMEI:</span> {{ sale.phone.imei|default:"N/A" }}
                  </div>
              </div>

              <div class="sale-payment">
                <div class="payment-badge">
                  <span class="payment-label">NAQD</span>
                  <div class="payment-value cash">${{ sale.cash_amount|floatformat:0|intcomma }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">KARTA</span>
                  <div class="payment-value card">${{ sale.card_amount|floatformat:0|intcomma }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">NASIYA</span>
                  <div class="payment-value installment">${{ sale.credit_amount|default:0|floatformat:0|intcomma }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">QARZ</span>
                  <div class="payment-value debt">${{ sale.debt_amount|floatformat:0|intcomma }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">FOYDA</span>
                  <div class="payment-value profit">${{ sale.calculated_profit|floatformat:0|intcomma }}</div>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="empty">Bu kunda telefon sotilmagan</div>
          {% endif %}
        </div>

        <div id="accessories-tab" class="tab-pane">
          {% if daily_stats.sales_data.accessory_sales %}
            {% for sale in daily_stats.sales_data.accessory_sales %}
            <div class="sale-item accessory">
              <div class="sale-header">
                <div>
                  <div class="sale-title">{{ sale.accessory.name }} × {{ sale.quantity }}</div>
                  <div class="sale-time">{{ sale.created_at|date:"H:i" }}</div>
                </div>
                <div class="sale-price uzs">{{ sale.total_price|floatformat:0 }} so'm</div>
              </div>
              <div class="sale-details">
                <div class="detail-row"><span class="detail-label">Mijoz:</span> {{ sale.customer.name }}</div>
                <div class="detail-row"><span class="detail-label">Sotuvchi:</span> {{ sale.salesman.get_full_name|default:sale.salesman.username }}</div>
              </div>
              <div class="sale-payment">
                <div class="payment-badge">
                  <span class="payment-label">NAQD</span>
                  <div class="payment-value cash">{{ sale.cash_amount|floatformat:0 }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">KARTA</span>
                  <div class="payment-value card">{{ sale.card_amount|floatformat:0 }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">NASIYA</span>
                  <div class="payment-value installment">{{ sale.credit_amount|default:0|floatformat:0 }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">QARZ</span>
                  <div class="payment-value debt">{{ sale.debt_amount|floatformat:0 }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">FOYDA</span>
                  <div class="payment-value profit">{{ sale.calculated_profit|floatformat:0|default:"0" }}</div>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="empty">Bu kunda aksessuar sotilmagan</div>
          {% endif %}
        </div>

        <div id="exchanges-tab" class="tab-pane">
          {% if daily_stats.sales_data.exchanges %}
            {% for exchange in daily_stats.sales_data.exchanges %}
            <div class="sale-item exchange">
              <div class="sale-header">
                <div>
                  <div class="sale-title">{{ exchange.old_phone_model }} → {{ exchange.new_phone.phone_model }}</div>
                  <div class="sale-time">{{ exchange.created_at|date:"H:i" }}</div>
                </div>
                <div class="sale-price usd">${{ exchange.additional_payment|floatformat:0|intcomma }}</div>
              </div>
              <div class="sale-details">
                <div class="detail-row"><span class="detail-label">Mijoz:</span> {{ exchange.customer_name }}</div>
                <div class="detail-row"><span class="detail-label">Sotuvchi:</span> {{ exchange.salesman.get_full_name|default:exchange.salesman.username }}</div>
                <div class="detail-row"><span class="detail-label">Eski qiymati:</span> ${{ exchange.old_phone_value|floatformat:0|intcomma }}</div>
                <div class="detail-row"><span class="detail-label">Yangi narxi:</span> ${{ exchange.new_phone_price|floatformat:0|intcomma }}</div>
              </div>
              <div class="sale-payment">
                <div class="payment-badge">
                  <span class="payment-label">NAQD</span>
                  <div class="payment-value cash">${{ exchange.cash_amount|default:0|floatformat:0|intcomma }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">KARTA</span>
                  <div class="payment-value card">${{ exchange.card_amount|default:0|floatformat:0|intcomma }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">NASIYA</span>
                  <div class="payment-value installment">{{ exchange.credit_amount|default:0|floatformat:0|intcomma }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">QARZ</span>
                  <div class="payment-value debt">{{ exchange.debt_amount|default:0|floatformat:0|intcomma }}</div>
                </div>
                <div class="payment-badge">
                  <span class="payment-label">FOYDA</span>
                  <div class="payment-value profit">${{ exchange.calculated_profit|floatformat:0|intcomma }}</div>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="empty">Bu kunda almashtirish bo'lmagan</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Sotuvchilar ({{ seller_stats|length }})</div>
      <div class="card-body">
        <div class="sellers">
          {% if seller_stats %}
            {% for seller_data in seller_stats %}
            <div class="seller" onclick="goToSeller({{ seller_data.seller.id }})">
              <div class="seller-header">
                <div class="seller-left">
                  <div class="seller-rank {% if forloop.counter == 1 %}gold{% elif forloop.counter == 2 %}silver{% elif forloop.counter == 3 %}bronze{% endif %}">
                    {{ forloop.counter }}
                  </div>
                  <div>
                    <div class="seller-name">{{ seller_data.seller.get_full_name|default:seller_data.seller.username }}</div>
                  </div>
                </div>
                <div class="seller-right">
                  <div class="seller-amount usd">${{ seller_data.sales.phone_total_usd|floatformat:0|intcomma }}</div>
                  <div class="seller-count">{{ seller_data.counts.phone|default:0 }} dona telefon</div>
                </div>
              </div>

              <!-- ✅ HAR BIR SOTUVCHINING O'Z STATISTIKASI -->
              <div class="seller-details">
                <div class="seller-detail-item">
                  <div class="seller-detail-label">Telefonlar</div>
                  <div class="seller-detail-value phone">{{ seller_data.counts.phone|default:0 }}</div>
                </div>
                <div class="seller-detail-item">
                  <div class="seller-detail-label">Aksessuarlar</div>
                  <div class="seller-detail-value accessory">{{ seller_data.counts.accessory|default:0 }}</div>
                </div>
                <div class="seller-detail-item">
                  <div class="seller-detail-label">Almashtirishlar</div>
                  <div class="seller-detail-value exchange">{{ seller_data.counts.exchange|default:0 }}</div>
                </div>
                <div class="seller-detail-item">
                  <div class="seller-detail-label">Qaytarishlar</div>
                  <div class="seller-detail-value return">{{ seller_data.counts.returns|default:0 }}</div>
                </div>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="empty">Sotuvchilar yo'q</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- CASH FLOW TAFSILOTLARI -->
  <div class="card" style="margin-bottom: 20px;">
    <div class="card-header">Cash Flow Tafsilotlari</div>
    <div class="card-body">
      <div class="stats-grid-5">
        <div class="stat">
          <div class="stat-label">Telefon Savdo</div>
          <div class="stat-value income">${{ daily_stats.cashflow.details.phone_sales|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Aksessuar Savdo</div>
          <div class="stat-value income">{{ daily_stats.cashflow.details.accessory_sales|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Almashtirish (Kirim)</div>
          <div class="stat-value income">${{ daily_stats.cashflow.details.exchange_income|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Olingan Telefon</div>
          <div class="stat-value expense">${{ daily_stats.cashflow.details.exchange_old_phone_value|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD (Chiqim)</div>
        </div>
        <div class="stat">
          <div class="stat-label">Teng Almashtirish</div>
          <div class="stat-value" style="color: #f59e0b;">{{ daily_stats.cashflow.details.exchange_equal|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
        <div class="stat">
          <div class="stat-label">Kunlik Sotuvchi</div>
          <div class="stat-value expense">${{ daily_stats.cashflow.details.daily_seller_payments|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Almashtirish (Chiqim)</div>
          <div class="stat-value expense">${{ daily_stats.cashflow.details.exchange_expenses|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Qaytarish</div>
          <div class="stat-value expense">${{ daily_stats.cashflow.details.phone_returns|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Harajatlar</div>
          <div class="stat-value expense">{{ daily_stats.cashflow.details.daily_expenses|floatformat:0 }}</div>
          <div class="stat-currency">UZS</div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function showTab(tabName) {
  document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName + '-tab').classList.add('active');
  event.target.classList.add('active');
}

function goToSeller(sellerId) {
  const params = new URLSearchParams(window.location.search);
  const baseUrl = "{% url 'reports:seller_detail_page' 999 %}".replace('999', sellerId);
  location.href = baseUrl + '?' + params;
}

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.stat-value.uzs, .seller-amount.uzs, .payment-value, .sale-price.uzs').forEach(function(elem) {
    let text = elem.textContent.trim();
    let number = text.replace(/[^\d]/g, '');
    if (number) {
      let formatted = number.replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
      if (text.includes('so\'m')) {
        elem.textContent = formatted + ' so\'m';
      } else {
        elem.textContent = formatted;
      }
    }
  });
});
</script>
{% endblock %}