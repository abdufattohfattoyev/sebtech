{% extends 'base.html' %}
{% load custom_filters %}
{% block page_title %}{{ seller.get_full_name|default:seller.username }} - Oylik Maosh{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Header */
.header {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
  padding: 25px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}
.header-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
.header-subtitle { font-size: 15px; opacity: 0.95; }

/* Filter */
.filter-card {
  background: white;
  padding: 18px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.filter-grid {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr auto;
  gap: 12px;
}
.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
  color: #374151;
}
.form-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
}
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary { background: #10b981; color: white; }
.btn-primary:hover { background: #059669; }

/* Alert */
.alert-warning {
  background: linear-gradient(135deg, #fef3c7, #fde68a);
  border-left: 5px solid #f59e0b;
  padding: 18px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 12px;
}
.alert-icon { font-size: 28px; color: #d97706; flex-shrink: 0; }
.alert-content h4 {
  margin: 0 0 6px 0;
  color: #92400e;
  font-size: 16px;
  font-weight: 700;
}
.alert-content p {
  margin: 0;
  color: #78350f;
  font-size: 13px;
  line-height: 1.5;
}

/* Charts */
.chart-section {
  background: white;
  padding: 25px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.chart-title {
  font-size: 18px;
  font-weight: 700;
  color: #111827;
  margin-bottom: 20px;
  text-align: center;
  text-transform: uppercase;
}
.chart-container {
  height: 350px;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-top: 4px solid;
}
.stat-card.primary { border-top-color: #10b981; }
.stat-card.info { border-top-color: #3b82f6; }
.stat-card.warning { border-top-color: #f59e0b; }
.stat-card.danger { border-top-color: #ef4444; }
.stat-label {
  font-size: 12px;
  color: #6b7280;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
  margin-bottom: 10px;
}
.stat-value {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 5px;
}
.stat-value.green { color: #10b981; }
.stat-value.blue { color: #3b82f6; }
.stat-value.orange { color: #f59e0b; }
.stat-value.red { color: #ef4444; }
.stat-currency {
  font-size: 12px;
  color: #9ca3af;
}

/* Daily Table */
.daily-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin-bottom: 20px;
  overflow: hidden;
}
.daily-header {
  padding: 18px 20px;
  background: #f9fafb;
  border-bottom: 2px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}
.daily-title {
  font-size: 16px;
  font-weight: 700;
  color: #111827;
}
.daily-count {
  font-size: 13px;
  color: #6b7280;
  background: white;
  padding: 6px 12px;
  border-radius: 20px;
  font-weight: 600;
}

/* Day Item */
.day-item {
  border-bottom: 1px solid #f3f4f6;
}
.day-item:last-child { border-bottom: none; }
.day-toggle {
  padding: 15px 20px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  transition: background 0.2s;
  flex-wrap: wrap;
  gap: 10px;
}
.day-toggle:hover { background: #f9fafb; }
.day-left {
  display: flex;
  align-items: center;
  gap: 15px;
  flex-wrap: wrap;
}
.day-date {
  font-weight: 700;
  font-size: 15px;
  color: #111827;
  min-width: 120px;
}
.day-badges {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.badge {
  padding: 5px 10px;
  border-radius: 14px;
  font-size: 12px;
  font-weight: 600;
}
.badge.phone { background: #dcfce7; color: #166534; }
.badge.accessory { background: #dbeafe; color: #1e40af; }
.badge.exchange { background: #fef3c7; color: #92400e; }
.badge.return { background: #fee2e2; color: #991b1b; }

.day-right {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
}
.day-summary {
  display: flex;
  gap: 15px;
  flex-wrap: wrap;
}
.day-summary-item {
  text-align: right;
}
.day-summary-label {
  font-size: 10px;
  color: #6b7280;
  font-weight: 600;
  text-transform: uppercase;
}
.day-summary-value {
  font-size: 15px;
  font-weight: 700;
  margin-top: 2px;
}
.day-summary-value.green { color: #10b981; }
.day-summary-value.blue { color: #3b82f6; }
.expand-icon {
  color: #9ca3af;
  font-size: 18px;
  transition: transform 0.3s;
}
.expand-icon.expanded {
  transform: rotate(180deg);
}

/* Day Details */
.day-details {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease;
}
.day-details.expanded {
  max-height: 3000px;
}
.details-content {
  padding: 20px;
  background: #fafafa;
}
.details-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 15px;
}
.detail-section {
  background: white;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.detail-title {
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 2px solid #e5e7eb;
  text-transform: uppercase;
}
.detail-title.phone { color: #10b981; border-bottom-color: #10b981; }
.detail-title.accessory { color: #3b82f6; border-bottom-color: #3b82f6; }
.detail-title.exchange { color: #f59e0b; border-bottom-color: #f59e0b; }
.detail-title.return { color: #ef4444; border-bottom-color: #ef4444; }

.sale-list {
  max-height: 300px;
  overflow-y: auto;
}
.sale-list::-webkit-scrollbar { width: 5px; }
.sale-list::-webkit-scrollbar-track { background: #f1f1f1; }
.sale-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

.sale-item {
  padding: 10px;
  background: #f9fafb;
  border-radius: 6px;
  margin-bottom: 8px;
  border-left: 3px solid;
}
.sale-item.phone { border-left-color: #10b981; }
.sale-item.accessory { border-left-color: #3b82f6; }
.sale-item.exchange { border-left-color: #f59e0b; }
.sale-item.return { border-left-color: #ef4444; background: #fef2f2; }
.sale-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 6px;
  flex-wrap: wrap;
  gap: 6px;
}
.sale-name {
  font-weight: 700;
  font-size: 12px;
  color: #111827;
}
.sale-price {
  font-weight: 700;
  font-size: 14px;
}
.sale-price.green { color: #10b981; }
.sale-price.blue { color: #3b82f6; }
.sale-price.orange { color: #f59e0b; }
.sale-price.red { color: #ef4444; }
.sale-meta {
  font-size: 11px;
  color: #6b7280;
  line-height: 1.5;
}

.empty {
  text-align: center;
  padding: 25px;
  color: #9ca3af;
  font-size: 12px;
}

/* Final Salary */
.final-salary {
  background: linear-gradient(135deg, #10b981, #059669);
  border-radius: 12px;
  padding: 35px;
  text-align: center;
  color: white;
  box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
}
.final-label {
  font-size: 15px;
  font-weight: 600;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-bottom: 12px;
  opacity: 0.95;
}
.final-value {
  font-size: 48px;
  font-weight: 700;
  margin-bottom: 15px;
  text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.final-breakdown {
  font-size: 14px;
  line-height: 1.8;
  opacity: 0.95;
}
.final-breakdown strong {
  font-weight: 700;
}
.final-warning {
  margin-top: 15px;
  padding: 12px 20px;
  background: rgba(220, 38, 38, 0.2);
  border-radius: 8px;
  display: inline-block;
  font-size: 13px;
  font-weight: 600;
}

/* Responsive */
@media (max-width: 1200px) {
  .details-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 992px) {
  .filter-grid { grid-template-columns: 1fr 1fr; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) {
  .container { padding: 15px; }
  .header { padding: 18px; }
  .header-title { font-size: 20px; }
  .filter-grid { grid-template-columns: 1fr; }
  .stats-grid { grid-template-columns: 1fr; }
  .details-grid { grid-template-columns: 1fr; }
  .day-toggle { flex-direction: column; align-items: flex-start; gap: 12px; }
  .day-right { width: 100%; justify-content: space-between; }
  .final-value { font-size: 36px; }
  .chart-container { height: 300px; }
}

@media (max-width: 480px) {
  .header-title { font-size: 18px; }
  .final-value { font-size: 32px; }
  .stat-value { font-size: 24px; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="header-title">{{ seller.get_full_name|default:seller.username }} - Oylik Maosh</div>
    <div class="header-subtitle">{{ month_names|get_item:month }} {{ year }} | {{ selected_shop.name }}</div>
  </div>

  <!-- Filter -->
  <div class="filter-card">
    <form method="get" class="filter-grid">
      <div class="form-group">
        <label>Do'kon</label>
        <select name="shop" class="form-select">
          {% for shop in shops %}
          <option value="{{ shop.id }}" {% if shop == selected_shop %}selected{% endif %}>{{ shop.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Yil</label>
        <select name="year" class="form-select">
          {% for y in years %}
          <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Oy</label>
        <select name="month" class="form-select">
          {% for m in months %}
          <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ month_names|get_item:m }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Ko'rsat</button>
    </form>
  </div>

  <!-- Alert -->
  {% if salary_data.sales.returns_count > 0 %}
  <div class="alert-warning">
    <div class="alert-icon">⚠️</div>
    <div class="alert-content">
      <h4>Bu oyda {{ salary_data.sales.returns_count }} ta telefon qaytarildi!</h4>
      <p>
        Qaytarilgan telefonlar sotish sonidan va foydadan to'liq ayirildi.
        Faqat hozirda faol sotuvlar uchun komissiya hisoblanadi.
      </p>
    </div>
  </div>
  {% endif %}

  <!-- Chart -->
  <div class="chart-section">
    <div class="chart-title">Oylik Kunlik Savdolar (Soni)</div>
    <div class="chart-container">
      <canvas id="dailySalesChart"></canvas>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card primary">
      <div class="stat-label">Ish Kunlari</div>
      <div class="stat-value green">{{ daily_data|length }}</div>
      <div class="stat-currency">kun</div>
    </div>
    <div class="stat-card info">
      <div class="stat-label">Telefon (Sof)</div>
      <div class="stat-value blue">{{ salary_data.sales.phone_count }}</div>
      <div class="stat-currency">dona</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-label">Aksessuar</div>
      <div class="stat-value orange">{{ salary_data.sales.accessory_count }}</div>
      <div class="stat-currency">dona</div>
    </div>
    <div class="stat-card info">
      <div class="stat-label">Almashtirish</div>
      <div class="stat-value blue">{{ salary_data.sales.exchange_count }}</div>
      <div class="stat-currency">dona</div>
    </div>
    {% if salary_data.sales.returns_count > 0 %}
    <div class="stat-card danger">
      <div class="stat-label">Qaytarilgan</div>
      <div class="stat-value red">{{ salary_data.sales.returns_count }}</div>
      <div class="stat-currency">dona</div>
    </div>
    {% endif %}
    <div class="stat-card primary">
      <div class="stat-label">Jami Maosh</div>
      <div class="stat-value green">${{ salary_data.commission.total_salary_usd|floatformat:2 }}</div>
      <div class="stat-currency">USD</div>
    </div>
  </div>

  <!-- Daily Details -->
  <div class="daily-card">
    <div class="daily-header">
      <div class="daily-title">Kunlik Savdolar</div>
      <div class="daily-count">{{ daily_data|length }} kun</div>
    </div>

    {% for day in daily_data %}
    <div class="day-item">
      <div class="day-toggle" onclick="toggleDay({{ forloop.counter }})">
        <div class="day-left">
          <div class="day-date">{{ day.date|date:"d M, D" }}</div>
          <div class="day-badges">
            <span class="badge phone">T:{{ day.counts.phone }}</span>
            <span class="badge accessory">A:{{ day.counts.accessory }}</span>
            <span class="badge exchange">E:{{ day.counts.exchange }}</span>
            {% if day.counts.returns > 0 %}
            <span class="badge return">Q:{{ day.counts.returns }}</span>
            {% endif %}
          </div>
        </div>
        <div class="day-right">
          <div class="day-summary">
            <div class="day-summary-item">
              <div class="day-summary-label">Tel.$</div>
              <div class="day-summary-value green">${{ day.sales.phone_total_usd|floatformat:0 }}</div>
            </div>
            <div class="day-summary-item">
              <div class="day-summary-label">Aks.so'm</div>
              <div class="day-summary-value blue">{{ day.sales.accessory_total_uzs|floatformat:0 }}</div>
            </div>
          </div>
          <span class="expand-icon" id="icon-{{ forloop.counter }}">▼</span>
        </div>
      </div>

      <div class="day-details" id="details-{{ forloop.counter }}">
        <div class="details-content">
          <div class="details-grid">
            <!-- Telefon -->
            <div class="detail-section">
              <div class="detail-title phone">Telefonlar ({{ day.counts.phone }})</div>
              <div class="sale-list">
                {% for sale in day.sales_data.phone_sales %}
                <div class="sale-item phone">
                  <div class="sale-header">
                    <div class="sale-name">{{ sale.phone.phone_model }} {{ sale.phone.memory_size }}</div>
                    <div class="sale-price green">${{ sale.sale_price|floatformat:2 }}</div>
                  </div>
                  <div class="sale-meta">
                    Mijoz: {{ sale.customer.name }}<br>
                    <strong style="color: #10b981;">Foyda: ${{ sale.calculated_profit|floatformat:2 }}</strong>
                  </div>
                </div>
                {% empty %}
                <div class="empty">Sotilmadi</div>
                {% endfor %}
              </div>
            </div>

            <!-- Aksessuar -->
            <div class="detail-section">
              <div class="detail-title accessory">Aksessuarlar ({{ day.counts.accessory }})</div>
              <div class="sale-list">
                {% for sale in day.sales_data.accessory_sales %}
                <div class="sale-item accessory">
                  <div class="sale-header">
                    <div class="sale-name">{{ sale.accessory.name }} ×{{ sale.quantity }}</div>
                    <div class="sale-price blue">{{ sale.total_price|floatformat:0 }} so'm</div>
                  </div>
                  <div class="sale-meta">
                    Mijoz: {{ sale.customer.name }}<br>
                    <strong style="color: #3b82f6;">Foyda: {{ sale.calculated_profit|floatformat:0 }} so'm</strong>
                  </div>
                </div>
                {% empty %}
                <div class="empty">Sotilmadi</div>
                {% endfor %}
              </div>
            </div>

            <!-- Almashtirish -->
            <div class="detail-section">
              <div class="detail-title exchange">Almashtirishlar ({{ day.counts.exchange }})</div>
              <div class="sale-list">
                {% for exchange in day.sales_data.exchanges %}
                <div class="sale-item exchange">
                  <div class="sale-header">
                    <div class="sale-name">{{ exchange.old_phone_model }} → {{ exchange.new_phone.phone_model }}</div>
                    <div class="sale-price orange">${{ exchange.new_phone_price|floatformat:2 }}</div>
                  </div>
                  <div class="sale-meta">
                    Mijoz: {{ exchange.customer_name }}<br>
                    <strong style="color: #f59e0b;">Foyda: ${{ exchange.calculated_profit|floatformat:2 }}</strong>
                  </div>
                </div>
                {% empty %}
                <div class="empty">Almashtirilmadi</div>
                {% endfor %}
              </div>
            </div>

            <!-- Qaytarilganlar -->
            <div class="detail-section">
              <div class="detail-title return">Qaytarilgan ({{ day.counts.returns }})</div>
              <div class="sale-list">
                {% for return in day.sales_data.phone_returns %}
                <div class="sale-item return">
                  <div class="sale-header">
                    <div class="sale-name">{{ return.phone_sale.phone.phone_model }}</div>
                    <div class="sale-price red">-${{ return.phone_sale.sale_price|floatformat:2 }}</div>
                  </div>
                  <div class="sale-meta">
                    Mijoz: {{ return.phone_sale.customer.name }}<br>
                    <strong style="color: #dc2626;">✕ Komissiya yo'q</strong>
                  </div>
                </div>
                {% empty %}
                <div class="empty">Qaytarilmadi</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="empty">Bu oyda savdo yo'q</div>
    {% endfor %}
  </div>

  <!-- Final Salary -->
  <div class="final-salary">
    <div class="final-label">OYLIK MAOSH (FAQAT FAOL SOTUVLARDAN)</div>
    <div class="final-value">${{ salary_data.commission.total_salary_usd|floatformat:2 }}</div>
    <div class="final-breakdown">
      <strong>Dollar hisobida:</strong><br>
      Asosiy maosh: ${{ salary_data.commission.base_salary_usd|floatformat:2 }} +
      Telefon komissiya ({{ salary_data.sales.phone_count }} dona): ${{ salary_data.commission.phone_commission|floatformat:2 }} +
      Almashtirish komissiya ({{ salary_data.sales.exchange_count }} dona): ${{ salary_data.commission.exchange_commission|floatformat:2 }}
      <br><br>
      <strong>So'm hisobida:</strong><br>
      Asosiy maosh: {{ salary_data.commission.base_salary_uzs|floatformat:0 }} so'm +
      Aksessuar komissiya ({{ salary_data.sales.accessory_count }} dona): {{ salary_data.commission.accessory_commission|floatformat:0 }} so'm =
      {{ salary_data.commission.total_salary_uzs|floatformat:0 }} so'm

      {% if salary_data.sales.returns_count > 0 %}
      <div class="final-warning">
        ⚠️ {{ salary_data.sales.returns_count }} ta qaytarilgan telefon hisobdan chiqarildi
      </div>
      {% endif %}
    </div>
  </div>
</div>

<script>
// KUNLIK GISTOGRAMMA
const dailyData = {
  labels: [{% for day in daily_data %}'{{ day.date|date:"d.m" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
  datasets: [
    {
      label: 'Telefonlar',
      data: [{% for day in daily_data %}{{ day.counts.phone|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: '#10b981',
      borderColor: '#059669',
      borderWidth: 2
    },
    {
      label: 'Aksessuarlar',
      data: [{% for day in daily_data %}{{ day.counts.accessory|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: '#3b82f6',
      borderColor: '#2563eb',
      borderWidth: 2
    },
    {
      label: 'Almashtirish',
      data: [{% for day in daily_data %}{{ day.counts.exchange|default:0 }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: '#f59e0b',
      borderColor: '#d97706',
      borderWidth: 2
    }
  ]
};

new Chart(document.getElementById('dailySalesChart'), {
  type: 'bar',
  data: dailyData,
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'top' },
      tooltip: {
        callbacks: {
          label: (context) => `${context.dataset.label}: ${context.parsed.y} dona`
        }
      }
    },
    scales: {
      x: { stacked: false },
      y: {
        beginAtZero: true,
        stacked: false,
        ticks: { stepSize: 1 }
      }
    }
  }
});

function toggleDay(dayId) {
  const details = document.getElementById(`details-${dayId}`);
  const icon = document.getElementById(`icon-${dayId}`);

  if (details.classList.contains('expanded')) {
    details.classList.remove('expanded');
    icon.classList.remove('expanded');
  } else {
    details.classList.add('expanded');
    icon.classList.add('expanded');
  }
}

// Birinchi kunni avtomatik ochish
document.addEventListener('DOMContentLoaded', function() {
  if (document.getElementById('details-1')) {
    toggleDay(1);
  }
});
</script>
{% endblock %}