{% extends 'base.html' %}
{% load custom_filters %}
{% block page_title %}{{ seller.get_full_name|default:seller.username }} - Oylik Maosh{% endblock %}

{% block extra_css %}
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, sans-serif; background: #f5f5f5; }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Header */
.header {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}
.header-title { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
.header-subtitle { font-size: 16px; opacity: 0.95; }

/* Filter */
.filter-card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.filter-grid {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr auto;
    gap: 15px;
}

/* Alert */
.alert-warning {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    border-left: 5px solid #f59e0b;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    gap: 15px;
}
.alert-icon { font-size: 32px; color: #d97706; }
.alert-content h4 {
    margin: 0 0 8px 0;
    color: #92400e;
    font-size: 18px;
    font-weight: 700;
}
.alert-content p {
    margin: 0;
    color: #78350f;
    font-size: 14px;
    line-height: 1.6;
}

/* Stats Grid */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}
.stat-card {
    background: white;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    border-top: 4px solid;
}
.stat-card.primary { border-top-color: #10b981; }
.stat-card.info { border-top-color: #3b82f6; }
.stat-card.success { border-top-color: #059669; }
.stat-card.warning { border-top-color: #f59e0b; }
.stat-label {
    font-size: 13px;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
    margin-bottom: 10px;
}
.stat-value {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 5px;
}
.stat-value.green { color: #10b981; }
.stat-value.blue { color: #3b82f6; }
.stat-value.red { color: #ef4444; }
.stat-currency {
    font-size: 14px;
    color: #9ca3af;
}

/* Category Cards */
.category-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    margin-bottom: 25px;
}
.category-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    overflow: hidden;
}
.category-header {
    padding: 20px 25px;
    font-weight: 700;
    font-size: 16px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 3px solid;
}
.category-header.usd {
    background: linear-gradient(135deg, #ecfdf5, #d1fae5);
    color: #065f46;
    border-bottom-color: #10b981;
}
.category-header.uzs {
    background: linear-gradient(135deg, #eff6ff, #dbeafe);
    color: #1e40af;
    border-bottom-color: #3b82f6;
}
.category-body { padding: 25px; }
.category-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
}
.category-stat {
    text-align: center;
    padding: 20px;
    background: #f9fafb;
    border-radius: 10px;
    border: 2px solid #e5e7eb;
}
.category-stat-label {
    font-size: 12px;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 8px;
}
.category-stat-value {
    font-size: 24px;
    font-weight: 700;
}
.category-stat-value.usd { color: #10b981; }
.category-stat-value.uzs { color: #3b82f6; }

/* Commission Card */
.commission-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 25px;
    overflow: hidden;
}
.commission-header {
    padding: 20px 25px;
    background: linear-gradient(135deg, #f9fafb, #ffffff);
    border-bottom: 2px solid #e5e7eb;
}
.commission-title {
    font-size: 18px;
    font-weight: 700;
    color: #111827;
    margin-bottom: 5px;
}
.commission-subtitle {
    font-size: 14px;
    color: #6b7280;
}
.commission-body { padding: 25px; }
.commission-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
.commission-section {
    padding: 20px;
    background: #f9fafb;
    border-radius: 10px;
    border: 2px solid;
}
.commission-section.usd { border-color: #10b981; }
.commission-section.uzs { border-color: #3b82f6; }
.commission-section-title {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.commission-section-title.usd { color: #10b981; }
.commission-section-title.uzs { color: #3b82f6; }
.commission-items { display: flex; flex-direction: column; gap: 12px; }
.commission-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    border-left: 4px solid;
}
.commission-item.phone { border-left-color: #10b981; }
.commission-item.accessory { border-left-color: #3b82f6; }
.commission-item.exchange { border-left-color: #f59e0b; }
.commission-item-left .label {
    font-weight: 600;
    font-size: 14px;
    color: #374151;
    margin-bottom: 4px;
}
.commission-item-left .calc {
    font-size: 12px;
    color: #6b7280;
}
.commission-item-right {
    font-size: 20px;
    font-weight: 700;
}
.commission-item-right.usd { color: #10b981; }
.commission-item-right.uzs { color: #3b82f6; }

/* Daily Section */
.daily-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    margin-bottom: 25px;
    overflow: hidden;
}
.daily-header {
    padding: 20px 25px;
    background: #f9fafb;
    border-bottom: 2px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.daily-title {
    font-size: 18px;
    font-weight: 700;
    color: #111827;
}
.daily-count {
    font-size: 14px;
    color: #6b7280;
    background: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 600;
}

/* Day Item */
.day-item {
    border-bottom: 1px solid #f3f4f6;
}
.day-item:last-child { border-bottom: none; }
.day-toggle {
    padding: 20px 25px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: background 0.2s;
}
.day-toggle:hover { background: #f9fafb; }
.day-left {
    display: flex;
    align-items: center;
    gap: 20px;
}
.day-date {
    font-weight: 700;
    font-size: 16px;
    color: #111827;
    min-width: 140px;
}
.day-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
}
.badge {
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 13px;
    font-weight: 600;
}
.badge.phone { background: #dcfce7; color: #166534; }
.badge.accessory { background: #dbeafe; color: #1e40af; }
.badge.exchange { background: #fef3c7; color: #92400e; }
.badge.return { background: #fee2e2; color: #991b1b; }

.day-right {
    display: flex;
    align-items: center;
    gap: 30px;
}
.day-summary {
    display: flex;
    gap: 20px;
}
.day-summary-item {
    text-align: right;
}
.day-summary-label {
    font-size: 11px;
    color: #6b7280;
    font-weight: 600;
    text-transform: uppercase;
}
.day-summary-value {
    font-size: 16px;
    font-weight: 700;
    margin-top: 4px;
}
.day-summary-value.green { color: #10b981; }
.day-summary-value.blue { color: #3b82f6; }
.expand-icon {
    color: #9ca3af;
    font-size: 20px;
    transition: transform 0.3s;
}
.expand-icon.expanded {
    transform: rotate(180deg);
}

/* Day Details */
.day-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
}
.day-details.expanded {
    max-height: 6000px;
}
.details-content {
    padding: 25px;
    background: #fafafa;
}
.details-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
}
.detail-section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}
.detail-title {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e5e7eb;
    text-transform: uppercase;
}
.detail-title.phone { color: #10b981; border-bottom-color: #10b981; }
.detail-title.accessory { color: #3b82f6; border-bottom-color: #3b82f6; }
.detail-title.exchange { color: #f59e0b; border-bottom-color: #f59e0b; }
.detail-title.return { color: #ef4444; border-bottom-color: #ef4444; }

.sale-list {
    max-height: 400px;
    overflow-y: auto;
}
.sale-list::-webkit-scrollbar { width: 6px; }
.sale-list::-webkit-scrollbar-track { background: #f1f1f1; }
.sale-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

.sale-item {
    padding: 12px;
    background: #f9fafb;
    border-radius: 8px;
    margin-bottom: 10px;
    border-left: 4px solid;
}
.sale-item.phone { border-left-color: #10b981; }
.sale-item.accessory { border-left-color: #3b82f6; }
.sale-item.exchange { border-left-color: #f59e0b; }
.sale-item.return { border-left-color: #ef4444; background: #fef2f2; }
.sale-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
}
.sale-name {
    font-weight: 700;
    font-size: 13px;
    color: #111827;
}
.sale-price {
    font-weight: 700;
    font-size: 15px;
}
.sale-price.green { color: #10b981; }
.sale-price.blue { color: #3b82f6; }
.sale-price.orange { color: #f59e0b; }
.sale-price.red { color: #ef4444; }
.sale-meta {
    font-size: 12px;
    color: #6b7280;
    line-height: 1.6;
}

.empty {
    text-align: center;
    padding: 30px;
    color: #9ca3af;
    font-size: 13px;
}

/* Final Salary */
.final-salary {
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 12px;
    padding: 40px;
    text-align: center;
    color: white;
    box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
}
.final-label {
    font-size: 16px;
    font-weight: 600;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 15px;
    opacity: 0.95;
}
.final-value {
    font-size: 56px;
    font-weight: 700;
    margin-bottom: 20px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.final-breakdown {
    font-size: 15px;
    line-height: 2;
    opacity: 0.95;
}
.final-breakdown strong {
    font-weight: 700;
}
.final-warning {
    margin-top: 20px;
    padding: 15px 25px;
    background: rgba(220, 38, 38, 0.2);
    border-radius: 8px;
    display: inline-block;
    font-size: 14px;
    font-weight: 600;
}

/* Responsive */
@media (max-width: 1200px) {
    .category-grid { grid-template-columns: 1fr; }
    .commission-grid { grid-template-columns: 1fr; }
    .details-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 768px) {
    .container { padding: 15px; }
    .filter-grid { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: 1fr; }
    .category-stats { grid-template-columns: 1fr; }
    .details-grid { grid-template-columns: 1fr; }
    .day-toggle { flex-direction: column; align-items: flex-start; gap: 15px; }
    .day-right { width: 100%; justify-content: space-between; }
    .final-value { font-size: 42px; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="header-title">{{ seller.get_full_name|default:seller.username }} - Oylik Maosh</div>
        <div class="header-subtitle">{{ month_names|get_item:month }} {{ year }} | {{ selected_shop.name }}</div>
    </div>

    <!-- Filter -->
    <div class="filter-card">
        <form method="get" class="filter-grid">
            <select name="shop" class="form-select">
                {% for shop in shops %}
                <option value="{{ shop.id }}" {% if shop == selected_shop %}selected{% endif %}>{{ shop.name }}</option>
                {% endfor %}
            </select>
            <select name="year" class="form-select">
                {% for y in years %}
                <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
                {% endfor %}
            </select>
            <select name="month" class="form-select">
                {% for m in months %}
                <option value="{{ m }}" {% if m == month %}selected{% endif %}>{{ month_names|get_item:m }}</option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-primary">Ko'rsat</button>
        </form>
    </div>

    <!-- Alert - Qaytarilganlar -->
    {% if salary_data.sales.returns_count > 0 %}
    <div class="alert-warning">
        <div class="alert-icon">‚ö†Ô∏è</div>
        <div class="alert-content">
            <h4>Bu oyda {{ salary_data.sales.returns_count }} ta telefon qaytarildi!</h4>
            <p>
                Qaytarilgan telefonlar <strong>sotish sonidan va foydadan to'liq ayirildi</strong>.
                Faqat hozirda faol sotuvlar uchun komissiya hisoblanadi.
            </p>
        </div>
    </div>
    {% endif %}

    <!-- Main Stats -->
    <div class="stats-grid">
        <div class="stat-card primary">
            <div class="stat-label">Ish Kunlari</div>
            <div class="stat-value green">{{ daily_data|length }}</div>
            <div class="stat-currency">kun</div>
        </div>
        <div class="stat-card info">
            <div class="stat-label">Telefon (Sof)</div>
            <div class="stat-value blue">{{ salary_data.sales.phone_count }}</div>
            <div class="stat-currency">dona</div>
        </div>
        <div class="stat-card warning">
            <div class="stat-label">Aksessuar</div>
            <div class="stat-value" style="color: #f59e0b;">{{ salary_data.sales.accessory_count }}</div>
            <div class="stat-currency">dona</div>
        </div>
        <div class="stat-card info">
            <div class="stat-label">Almashtirish</div>
            <div class="stat-value blue">{{ salary_data.sales.exchange_count }}</div>
            <div class="stat-currency">dona</div>
        </div>
        {% if salary_data.sales.returns_count > 0 %}
        <div class="stat-card" style="border-top-color: #ef4444;">
            <div class="stat-label">Qaytarilgan</div>
            <div class="stat-value red">{{ salary_data.sales.returns_count }}</div>
            <div class="stat-currency">dona</div>
        </div>
        {% endif %}
        <div class="stat-card success">
            <div class="stat-label">Jami Maosh</div>
            <div class="stat-value green">${{ salary_data.commission.total_salary_usd|floatformat:2 }}</div>
            <div class="stat-currency">USD</div>
        </div>
    </div>

    <!-- Category Cards -->
    <div class="category-grid">
        <!-- Telefon va Almashtirish -->
        <div class="category-card">
            <div class="category-header usd">üíµ Telefon & Almashtirish (Dollar)</div>
            <div class="category-body">
                <div class="category-stats">
                    <div class="category-stat">
                        <div class="category-stat-label">Savdo</div>
                        <div class="category-stat-value usd">${{ salary_data.sales.phone_total|floatformat:2 }}</div>
                    </div>
                    <div class="category-stat">
                        <div class="category-stat-label">Soni (Faol)</div>
                        <div class="category-stat-value usd">{{ salary_data.sales.phone_count|add:salary_data.sales.exchange_count }}</div>
                    </div>
                    <div class="category-stat">
                        <div class="category-stat-label">Foyda (Faol)</div>
                        <div class="category-stat-value usd">${{ salary_data.profits.phone_profit|add:salary_data.profits.exchange_profit|floatformat:2 }}</div>
                    </div>
                    <div class="category-stat">
                        <div class="category-stat-label">Komissiya</div>
                        <div class="category-stat-value usd">${{ salary_data.commission.phone_commission|add:salary_data.commission.exchange_commission|floatformat:2 }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aksessuar -->
        <div class="category-card">
            <div class="category-header uzs">üõí Aksessuar (So'm)</div>
            <div class="category-body">
                <div class="category-stats">
                    <div class="category-stat">
                        <div class="category-stat-label">Savdo</div>
                        <div class="category-stat-value uzs">{{ salary_data.sales.accessory_total|floatformat:0 }}</div>
                    </div>
                    <div class="category-stat">
                        <div class="category-stat-label">Soni</div>
                        <div class="category-stat-value uzs">{{ salary_data.sales.accessory_count }}</div>
                    </div>
                    <div class="category-stat">
                        <div class="category-stat-label">Foyda</div>
                        <div class="category-stat-value uzs">{{ salary_data.profits.accessory_profit|floatformat:0 }}</div>
                    </div>
                    <div class="category-stat">
                        <div class="category-stat-label">Komissiya</div>
                        <div class="category-stat-value uzs">{{ salary_data.commission.accessory_commission|floatformat:0 }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Commission Details -->
    <div class="commission-card">
        <div class="commission-header">
            <div class="commission-title">Komissiya Tafsilotlari</div>
            <div class="commission-subtitle">
                Faqat faol sotuvlar uchun hisoblanadi
                {% if salary_data.sales.returns_count > 0 %}
                <span style="color: #dc2626; font-weight: 600;">({{ salary_data.sales.returns_count }} ta qaytarilgan hisobga olinmadi)</span>
                {% endif %}
            </div>
        </div>
        <div class="commission-body">
            <div class="commission-grid">
                <!-- Dollar -->
                <div class="commission-section usd">
                    <div class="commission-section-title usd">
                        <span>üíµ</span>
                        <span>Dollar Komissiyalari (Faol)</span>
                    </div>
                    <div class="commission-items">
                        <div class="commission-item phone">
                            <div class="commission-item-left">
                                <div class="label">Telefon (Faol)</div>
                                <div class="calc">${{ salary_data.profits.phone_profit|floatformat:2 }} √ó {{ salary_data.commission_rates.phone_rate }}%</div>
                            </div>
                            <div class="commission-item-right usd">${{ salary_data.commission.phone_commission|floatformat:2 }}</div>
                        </div>
                        <div class="commission-item exchange">
                            <div class="commission-item-left">
                                <div class="label">Almashtirish</div>
                                <div class="calc">${{ salary_data.profits.exchange_profit|floatformat:2 }} √ó {{ salary_data.commission_rates.exchange_rate }}%</div>
                            </div>
                            <div class="commission-item-right usd">${{ salary_data.commission.exchange_commission|floatformat:2 }}</div>
                        </div>
                    </div>
                </div>

                <!-- So'm -->
                <div class="commission-section uzs">
                    <div class="commission-section-title uzs">
                        <span>üõí</span>
                        <span>So'm Komissiya</span>
                    </div>
                    <div class="commission-items">
                        <div class="commission-item accessory">
                            <div class="commission-item-left">
                                <div class="label">Aksessuar</div>
                                <div class="calc">{{ salary_data.profits.accessory_profit|floatformat:0 }} √ó {{ salary_data.commission_rates.accessory_rate }}%</div>
                            </div>
                            <div class="commission-item-right uzs">{{ salary_data.commission.accessory_commission|floatformat:0 }} so'm</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Details -->
    <div class="daily-card">
        <div class="daily-header">
            <div class="daily-title">Kunlik Savdolar</div>
            <div class="daily-count">{{ daily_data|length }} kun</div>
        </div>

        {% for day in daily_data %}
        <div class="day-item">
            <div class="day-toggle" onclick="toggleDay({{ forloop.counter }})">
                <div class="day-left">
                    <div class="day-date">{{ day.date|date:"d M, D" }}</div>
                    <div class="day-badges">
                        <span class="badge phone">T:{{ day.counts.phone }}</span>
                        <span class="badge accessory">A:{{ day.counts.accessory }}</span>
                        <span class="badge exchange">E:{{ day.counts.exchange }}</span>
                        {% if day.counts.returns > 0 %}
                        <span class="badge return">Q:{{ day.counts.returns }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="day-right">
                    <div class="day-summary">
                        <div class="day-summary-item">
                            <div class="day-summary-label">Tel.$</div>
                            <div class="day-summary-value green">${{ day.sales.phone_total_usd|floatformat:0 }}</div>
                        </div>
                        <div class="day-summary-item">
                            <div class="day-summary-label">Aks.so'm</div>
                            <div class="day-summary-value blue">{{ day.sales.accessory_total_uzs|floatformat:0 }}</div>
                        </div>
                    </div>
                    <span class="expand-icon" id="icon-{{ forloop.counter }}">‚ñº</span>
                </div>
            </div>

            <div class="day-details" id="details-{{ forloop.counter }}">
                <div class="details-content">
                    <div class="details-grid">
                        <!-- Telefon Sotuvlari -->
                        <div class="detail-section">
                            <div class="detail-title phone">üì± Telefonlar ({{ day.counts.phone }})</div>
                            <div class="sale-list">
                                {% for sale in day.sales_data.phone_sales %}
                                <div class="sale-item phone">
                                    <div class="sale-header">
                                        <div class="sale-name">{{ sale.phone.phone_model }} {{ sale.phone.memory_size }}</div>
                                        <div class="sale-price green">${{ sale.sale_price|floatformat:2 }}</div>
                                    </div>
                                    <div class="sale-meta">
                                        <strong>Mijoz:</strong> {{ sale.customer.name }}<br>
                                        <strong>IMEI:</strong> {{ sale.phone.imei|default:"N/A" }}<br>
                                        <strong>Naqd:</strong> ${{ sale.cash_amount|floatformat:0 }}
                                        {% if sale.card_amount > 0 %} | <strong>Karta:</strong> ${{ sale.card_amount|floatformat:0 }}{% endif %}
                                        {% if sale.debt_amount > 0 %} | <strong>Qarz:</strong> ${{ sale.debt_amount|floatformat:0 }}{% endif %}<br>
                                        <strong style="color: #10b981;">Foyda: ${{ sale.calculated_profit|floatformat:2 }}</strong>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="empty">Sotilmadi</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Aksessuarlar -->
                        <div class="detail-section">
                            <div class="detail-title accessory">üõí Aksessuarlar ({{ day.counts.accessory }})</div>
                            <div class="sale-list">
                                {% for sale in day.sales_data.accessory_sales %}
                                <div class="sale-item accessory">
                                    <div class="sale-header">
                                        <div class="sale-name">{{ sale.accessory.name }} √ó{{ sale.quantity }}</div>
                                        <div class="sale-price blue">{{ sale.total_price|floatformat:0 }} so'm</div>
                                    </div>
                                    <div class="sale-meta">
                                        <strong>Mijoz:</strong> {{ sale.customer.name }}<br>
                                        <strong>Birlik:</strong> {{ sale.unit_price|floatformat:0 }} so'm<br>
                                        <strong>Naqd:</strong> {{ sale.cash_amount|floatformat:0 }}
                                        {% if sale.card_amount > 0 %} | <strong>Karta:</strong> {{ sale.card_amount|floatformat:0 }}{% endif %}<br>
                                        <strong style="color: #3b82f6;">Foyda: {{ sale.calculated_profit|floatformat:0 }} so'm</strong>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="empty">Sotilmadi</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Almashtirishlar -->
                        <div class="detail-section">
                            <div class="detail-title exchange">üîÑ Almashtirishlar ({{ day.counts.exchange }})</div>
                            <div class="sale-list">
                                {% for exchange in day.sales_data.exchanges %}
                                <div class="sale-item exchange">
                                    <div class="sale-header">
                                        <div class="sale-name">{{ exchange.old_phone_model }} ‚Üí {{ exchange.new_phone.phone_model }}</div>
                                        <div class="sale-price orange">${{ exchange.new_phone_price|floatformat:2 }}</div>
                                    </div>
                                    <div class="sale-meta">
                                        <strong>Mijoz:</strong> {{ exchange.customer_name }}<br>
                                        <strong>Eski:</strong> ${{ exchange.old_phone_accepted_price|floatformat:2 }} | <strong>Yangi:</strong> ${{ exchange.new_phone_price|floatformat:2 }}<br>
                                        <strong>Farq:</strong> ${{ exchange.price_difference|floatformat:2 }}<br>
                                        <strong style="color: #f59e0b;">Foyda: ${{ exchange.calculated_profit|floatformat:2 }}</strong>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="empty">Almashtirilmadi</div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Qaytarilganlar -->
                        <div class="detail-section">
                            <div class="detail-title return">‚ö†Ô∏è Qaytarilgan ({{ day.counts.returns }})</div>
                            <div class="sale-list">
                                {% for return in day.sales_data.phone_returns %}
                                <div class="sale-item return">
                                    <div class="sale-header">
                                        <div class="sale-name">{{ return.phone_sale.phone.phone_model }} {{ return.phone_sale.phone.memory_size }}</div>
                                        <div class="sale-price red">-${{ return.phone_sale.sale_price|floatformat:2 }}</div>
                                    </div>
                                    <div class="sale-meta">
                                        <strong>Mijoz:</strong> {{ return.phone_sale.customer.name }}<br>
                                        <strong>IMEI:</strong> {{ return.phone_sale.phone.imei|default:"N/A" }}<br>
                                        <strong style="color: #dc2626;">Sabab:</strong> {{ return.reason|truncatewords:8 }}<br>
                                        <strong style="color: #dc2626;">‚ùå Komissiya yo'q</strong>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="empty">Qaytarilmadi</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="empty">Bu oyda savdo yo'q</div>
        {% endfor %}
    </div>

    <!-- Final Salary -->
    <div class="final-salary">
        <div class="final-label">OYLIK MAOSH (FAQAT FAOL SOTUVLARDAN)</div>
        <div class="final-value">${{ salary_data.commission.total_salary_usd|floatformat:2 }}</div>
        <div class="final-breakdown">
            <strong>Dollar hisobida:</strong><br>
            Asosiy maosh: ${{ salary_data.commission.base_salary_usd|floatformat:2 }} +
            Telefon komissiya ({{ salary_data.sales.phone_count }} dona): ${{ salary_data.commission.phone_commission|floatformat:2 }} +
            Almashtirish komissiya ({{ salary_data.sales.exchange_count }} dona): ${{ salary_data.commission.exchange_commission|floatformat:2 }}
            <br><br>
            <strong>So'm hisobida:</strong><br>
            Asosiy maosh: {{ salary_data.commission.base_salary_uzs|floatformat:0 }} so'm +
            Aksessuar komissiya ({{ salary_data.sales.accessory_count }} dona): {{ salary_data.commission.accessory_commission|floatformat:0 }} so'm =
            {{ salary_data.commission.total_salary_uzs|floatformat:0 }} so'm

            {% if salary_data.sales.returns_count > 0 %}
            <div class="final-warning">
                ‚ö†Ô∏è {{ salary_data.sales.returns_count }} ta qaytarilgan telefon hisobdan chiqarildi
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function toggleDay(dayId) {
    const details = document.getElementById(`details-${dayId}`);
    const icon = document.getElementById(`icon-${dayId}`);

    if (details.classList.contains('expanded')) {
        details.classList.remove('expanded');
        icon.classList.remove('expanded');
    } else {
        details.classList.add('expanded');
        icon.classList.add('expanded');
    }
}

// Birinchi kunni avtomatik ochish
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('details-1')) {
        toggleDay(1);
    }
});
</script>
{% endblock %}