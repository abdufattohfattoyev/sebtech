{% extends 'base.html' %}
{% load humanize %}
{% block page_title %}Kunlik Hisobot{% endblock %}

{% block extra_css %}
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Header */
.header {
  background: linear-gradient(135deg, #2563eb, #1d4ed8);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 700; }
.header-date { font-size: 14px; opacity: 0.95; }
.nav { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
.nav a {
  padding: 10px 18px;
  background: rgba(255,255,255,0.15);
  border-radius: 8px;
  color: white;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}
.nav a:hover { background: rgba(255,255,255,0.25); }
.nav a.active { background: rgba(255,255,255,0.35); }

/* Filter */
.filter {
  background: white;
  padding: 18px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.filter-row {
  display: grid;
  grid-template-columns: 2fr 1fr auto auto;
  gap: 12px;
  align-items: end;
}
.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
  color: #374151;
}
.form-control, .form-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  transition: border 0.2s;
}
.form-control:focus, .form-select:focus {
  outline: none;
  border-color: #2563eb;
}
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}
.btn-primary { background: #2563eb; color: white; }
.btn-primary:hover { background: #1d4ed8; }
.btn-secondary { background: #6b7280; color: white; }
.btn-secondary:hover { background: #4b5563; }

/* Stats Container */
.stats-container {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-bottom: 20px;
}
.stats-section {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.stats-section-title {
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
  padding-bottom: 10px;
  border-bottom: 3px solid;
}
.stats-section-title.usd { border-color: #10b981; color: #10b981; }
.stats-section-title.uzs { border-color: #3b82f6; color: #3b82f6; }
.stats-section-title.cashflow { border-color: #f59e0b; color: #f59e0b; }
.stats-section-title.kassa-title { border-color: #10b981; color: #065f46; }

.stats-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
.stats-grid-3 {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.stats-grid-5 {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 12px;
}

.stat {
  text-align: center;
  padding: 16px;
  background: linear-gradient(135deg, #f9fafb, #ffffff);
  border-radius: 10px;
  border: 1px solid #e5e7eb;
  transition: transform 0.2s;
}
.stat:hover { transform: translateY(-2px); }
.stat-label {
  font-size: 11px;
  color: #6b7280;
  margin-bottom: 8px;
  font-weight: 600;
  text-transform: uppercase;
  line-height: 1.3;
}
.stat-value {
  font-size: 22px;
  font-weight: 700;
  line-height: 1;
  word-break: break-word;
}
.stat-value.usd { color: #10b981; }
.stat-value.uzs { color: #3b82f6; }
.stat-value.income { color: #10b981; }
.stat-value.expense { color: #dc2626; }
.stat-value.net { color: #8b5cf6; }
.stat-value.installment { color: #f59e0b; }
.stat-currency {
  font-size: 10px;
  color: #9ca3af;
  margin-top: 6px;
  font-weight: 500;
}

/* JAMI FOYDA CARD */
.total-profit-card {
  grid-column: span 2;
  background: linear-gradient(135deg, #d1fae5, #a7f3d0);
  border: 3px solid #10b981;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}
.total-profit-card .stat-label {
  font-size: 13px;
  font-weight: 700;
  color: #065f46;
}
.total-profit-card .stat-value {
  font-size: 32px;
  color: #065f46;
}
.total-profit-card .stat-currency {
  font-size: 11px;
  color: #059669;
}

/* Kassa Section */
.kassa-section {
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
  border: 2px solid #10b981;
}
.kassa-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}
.kassa-stat {
  text-align: center;
  padding: 16px;
  background: white;
  border-radius: 10px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}
.kassa-stat.highlight {
  border: 3px solid #10b981;
  background: linear-gradient(135deg, #ffffff, #f0fdf4);
}

/* Cash Flow Section */
.cashflow-section {
  background: linear-gradient(135deg, #fffbeb, #fef3c7);
  border: 2px solid #f59e0b;
}
.cashflow-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 12px;
}

/* Main */
.main {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
.card {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.card-header {
  padding: 16px 20px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-bottom: 1px solid #e5e7eb;
  font-weight: 700;
  font-size: 14px;
}
.card-body { padding: 18px; }

/* Tabs */
.tabs { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
.tab-btn {
  flex: 1;
  padding: 10px 14px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  background: white;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  min-width: 100px;
  transition: all 0.2s;
}
.tab-btn:hover { background: #f9fafb; }
.tab-btn.active { background: #2563eb; color: white; border-color: #2563eb; }

.tab-pane { display: none; max-height: 520px; overflow-y: auto; }
.tab-pane.active { display: block; }

/* Sale Items */
.sale-item {
  padding: 14px;
  margin-bottom: 10px;
  background: #fafafa;
  border-left: 4px solid;
  border-radius: 8px;
  transition: all 0.2s;
}
.sale-item:hover { transform: translateX(3px); }
.sale-item.phone {
  border-left-color: #10b981;
  background: linear-gradient(135deg, #ecfdf5, #fafafa);
}
.sale-item.accessory {
  border-left-color: #3b82f6;
  background: linear-gradient(135deg, #eff6ff, #fafafa);
}
.sale-item.exchange {
  border-left-color: #f59e0b;
  background: linear-gradient(135deg, #fffbeb, #fafafa);
}

.sale-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
  flex-wrap: wrap;
  gap: 8px;
}
.sale-title { font-weight: 700; font-size: 14px; color: #111827; }
.sale-time { font-size: 11px; color: #6b7280; font-weight: 500; }
.sale-price { font-weight: 700; font-size: 16px; }
.sale-price.usd { color: #10b981; }
.sale-price.uzs { color: #3b82f6; }

.sale-details { font-size: 12px; color: #4b5563; line-height: 1.6; }
.detail-row { margin-bottom: 4px; }
.detail-label { color: #6b7280; font-weight: 500; }

.sale-payment {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  margin-top: 10px;
}
.payment-badge {
  padding: 8px;
  background: white;
  border-radius: 6px;
  text-align: center;
  font-size: 11px;
  border: 1px solid #e5e7eb;
}
.payment-label {
  font-size: 9px;
  color: #6b7280;
  display: block;
  margin-bottom: 4px;
  font-weight: 600;
}
.payment-value { font-weight: 700; font-size: 12px; word-break: break-word; }
.payment-value.cash { color: #10b981; }
.payment-value.card { color: #3b82f6; }
.payment-value.installment { color: #f59e0b; }
.payment-value.debt { color: #dc2626; }
.payment-value.profit { color: #8b5cf6; }

/* Sellers */
.sellers { max-height: 550px; overflow-y: auto; }
.seller {
  padding: 14px;
  border-bottom: 1px solid #f3f4f6;
  cursor: pointer;
  transition: all 0.2s;
}
.seller:hover { background: #f9fafb; }
.seller-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.seller-left { display: flex; align-items: center; gap: 12px; }
.seller-rank {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: #6b7280;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 700;
  flex-shrink: 0;
}
.seller-rank.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); }
.seller-rank.silver { background: linear-gradient(135deg, #e2e8f0, #94a3b8); }
.seller-rank.bronze { background: linear-gradient(135deg, #f59e0b, #d97706); }
.seller-name { font-weight: 700; font-size: 14px; color: #111827; }
.seller-right { text-align: right; }
.seller-amount { font-weight: 700; font-size: 15px; margin-bottom: 4px; }
.seller-amount.usd { color: #10b981; }
.seller-count { font-size: 12px; color: #6b7280; font-weight: 500; }

.seller-details {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-top: 10px;
  padding-top: 10px;
  border-top: 1px solid #e5e7eb;
}
.seller-detail-item {
  text-align: center;
  padding: 8px;
  background: #f9fafb;
  border-radius: 6px;
  border: 1px solid #e5e7eb;
}
.seller-detail-label {
  font-size: 9px;
  color: #6b7280;
  font-weight: 600;
  text-transform: uppercase;
  margin-bottom: 4px;
}
.seller-detail-value {
  font-size: 14px;
  font-weight: 700;
}
.seller-detail-value.phone { color: #10b981; }
.seller-detail-value.accessory { color: #3b82f6; }
.seller-detail-value.exchange { color: #f59e0b; }
.seller-detail-value.return { color: #dc2626; }

.empty {
  text-align: center;
  padding: 40px 20px;
  color: #9ca3af;
  font-size: 13px;
}

/* Print */
@media print {
  .filter, .nav, .btn { display: none !important; }
  .container { padding: 10px; }
  .card { page-break-inside: avoid; }
}

/* Responsive */
@media (max-width: 1200px) {
  .stats-grid-5 { grid-template-columns: repeat(4, 1fr); }
}

@media (max-width: 1024px) {
  .stats-container { grid-template-columns: 1fr; }
  .main { grid-template-columns: 1fr; }
  .stats-grid-5 { grid-template-columns: repeat(3, 1fr); }
}

@media (max-width: 768px) {
  .filter-row { grid-template-columns: 1fr; }
  .stats-grid-5 { grid-template-columns: repeat(2, 1fr); }
  .seller-details { grid-template-columns: repeat(2, 1fr); }
  .sale-payment { grid-template-columns: repeat(3, 1fr); }
  .kassa-grid { grid-template-columns: 1fr; }
  .cashflow-grid { grid-template-columns: 1fr; }
  .total-profit-card { grid-column: span 1; }
}

@media (max-width: 480px) {
  .container { padding: 10px; }
  .stats-grid-5 { grid-template-columns: 1fr; }
  .seller-details { grid-template-columns: repeat(2, 1fr); }
  .sale-payment { grid-template-columns: repeat(2, 1fr); }
  .stats-grid, .stats-grid-3 { grid-template-columns: 1fr; }
  .tabs { flex-direction: column; }
  .tab-btn { min-width: auto; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="header">
    <h1>{{ selected_shop.name }}</h1>
    <div class="header-date">{{ selected_date|date:"d F Y, l" }}</div>
    <div class="nav">
      <a href="{% url 'reports:daily' %}?shop={{ selected_shop.id }}" class="active">Kunlik</a>
      <a href="{% url 'reports:monthly' %}?shop={{ selected_shop.id }}">Oylik</a>
      <a href="{% url 'reports:yearly' %}?shop={{ selected_shop.id }}">Yillik</a>
    </div>
  </div>

  <div class="filter">
    <form method="get">
      <div class="filter-row">
        <div class="form-group">
          <label>Do'kon</label>
          <select name="shop" class="form-select">
            {% for shop in shops %}
            <option value="{{ shop.id }}" {% if shop == selected_shop %}selected{% endif %}>{{ shop.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Sana</label>
          <input type="date" name="date" class="form-control" value="{{ selected_date|date:'Y-m-d' }}">
        </div>
        <button type="submit" class="btn btn-primary">Ko'rsat</button>
        <button type="button" class="btn btn-secondary" onclick="window.print()">Chop</button>
      </div>
    </form>
  </div>

  <!-- TELEFON VA AKSESSUAR -->
  <div class="stats-container">
    <div class="stats-section">
      <div class="stats-section-title usd">TELEFON + ALMASHTIRISH (Dollar)</div>
      <div class="stats-grid">
        <div class="stat">
          <div class="stat-label">Jami Savdo</div>
          <div class="stat-value usd">${{ daily_stats.sales.phone_total_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Naqd</div>
          <div class="stat-value usd">${{ daily_stats.sales.phone_cash_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Karta</div>
          <div class="stat-value usd">${{ daily_stats.sales.phone_card_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Nasiya</div>
          <div class="stat-value installment">${{ daily_stats.sales.phone_credit_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Qarz</div>
          <div class="stat-value expense">${{ daily_stats.sales.phone_debt_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Telefon Soni</div>
          <div class="stat-value usd">{{ daily_stats.counts.phone|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
        <div class="stat">
          <div class="stat-label">Almashtirish</div>
          <div class="stat-value usd">{{ daily_stats.counts.exchange|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
        <div class="stat">
          <div class="stat-label">Qaytarish</div>
          <div class="stat-value expense">{{ daily_stats.counts.returns|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
        <div class="stat">
          <div class="stat-label">Tel. Foyda</div>
          <div class="stat-value usd">${{ daily_stats.profits.phone_profit|floatformat:0|intcomma|default:"0" }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Alm. Foyda</div>
          <div class="stat-value usd">${{ daily_stats.profits.exchange_profit|floatformat:0|intcomma|default:"0" }}</div>
          <div class="stat-currency">USD</div>
        </div>

        <!-- JAMI FOYDA -->
        <div class="stat total-profit-card">
          <div class="stat-label">JAMI FOYDA (Tel + Alm)</div>
          <div class="stat-value">${{ daily_stats.profits.total_phone_exchange_profit|floatformat:0|intcomma|default:"0" }}</div>
          <div class="stat-currency">USD</div>
        </div>
      </div>
    </div>

    <div class="stats-section">
      <div class="stats-section-title uzs">AKSESSUAR (So'm)</div>
      <div class="stats-grid">
        <div class="stat">
          <div class="stat-label">Jami Savdo</div>
          <div class="stat-value uzs">{{ daily_stats.sales.accessory_total_uzs|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Naqd</div>
          <div class="stat-value uzs">{{ daily_stats.sales.accessory_cash_uzs|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Karta</div>
          <div class="stat-value uzs">{{ daily_stats.sales.accessory_card_uzs|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Nasiya</div>
          <div class="stat-value installment">{{ daily_stats.sales.accessory_credit_uzs|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Qarz</div>
          <div class="stat-value expense">{{ daily_stats.sales.accessory_debt_uzs|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Soni</div>
          <div class="stat-value uzs">{{ daily_stats.counts.accessory|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
        <div class="stat">
          <div class="stat-label">Xarajat</div>
          <div class="stat-value expense">{{ daily_stats.expenses|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Foyda</div>
          <div class="stat-value uzs">{{ daily_stats.profits.accessory_profit|floatformat:0|intcomma|default:"0" }}</div>
          <div class="stat-currency">UZS</div>
        </div>
      </div>
    </div>
  </div>

  <!-- CASH FLOW -->
  <div class="stats-container">
    <div class="stats-section cashflow-section">
      <div class="stats-section-title cashflow">CASH FLOW - DOLLAR</div>
      <div class="cashflow-grid">
        <div class="stat">
          <div class="stat-label">Kirim</div>
          <div class="stat-value income">${{ daily_stats.cashflow.usd.income|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Chiqim</div>
          <div class="stat-value expense">${{ daily_stats.cashflow.usd.expense|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="stat">
          <div class="stat-label">Sof Balans</div>
          <div class="stat-value net">${{ daily_stats.cashflow.usd.net|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
      </div>
    </div>

    <div class="stats-section cashflow-section">
      <div class="stats-section-title cashflow">CASH FLOW - SO'M</div>
      <div class="cashflow-grid">
        <div class="stat">
          <div class="stat-label">Kirim</div>
          <div class="stat-value income">{{ daily_stats.cashflow.uzs.income|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Chiqim</div>
          <div class="stat-value expense">{{ daily_stats.cashflow.uzs.expense|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="stat">
          <div class="stat-label">Sof Balans</div>
          <div class="stat-value net">{{ daily_stats.cashflow.uzs.net|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
      </div>
    </div>
  </div>

  <!-- KASSADA NAQD -->
  <div class="stats-container">
    <div class="stats-section kassa-section">
      <div class="stats-section-title kassa-title">KASSADA NAQD</div>
      <div class="kassa-grid">
        <div class="kassa-stat highlight">
          <div class="stat-label">Dollar (Naqd)</div>
          <div class="stat-value usd">${{ daily_stats.sales.phone_cash_usd|floatformat:0|intcomma }}</div>
          <div class="stat-currency">USD</div>
        </div>
        <div class="kassa-stat highlight">
          <div class="stat-label">So'm (Naqd - Xarajat)</div>
          <div class="stat-value uzs">{{ daily_stats.net_cash_uzs|floatformat:0|intcomma }}</div>
          <div class="stat-currency">UZS</div>
        </div>
        <div class="kassa-stat">
          <div class="stat-label">Teng Almashtirish</div>
          <div class="stat-value" style="color: #f59e0b; font-size: 24px;">{{ daily_stats.cashflow.details.exchange_equal|default:0 }}</div>
          <div class="stat-currency">dona</div>
        </div>
      </div>
    </div>
  </div>

  <div class="main">
    <div class="card">
      <div class="card-header">Sotuvlar Tafsiloti</div>
      <div class="card-body">
        <div class="tabs">
          <button class="tab-btn active" onclick="showTab('phones')">Telefonlar ({{ daily_stats.counts.phone|default:0 }})</button>
          <button class="tab-btn" onclick="showTab('accessories')">Aksessuarlar ({{ daily_stats.counts.accessory|default:0 }})</button>
          <button class="tab-btn" onclick="showTab('exchanges')">Almashtirish ({{ daily_stats.counts.exchange|default:0 }})</button>
        </div>

        <div id="phones-tab" class="tab-pane active">
          {% if daily_stats.sales_data.phone_sales %}
            {% for sale in daily_stats.sales_data.phone_sales %}
            <div class="sale-item phone">
              <div class="sale-header">
                <div>
                  <div class="sale-title">{{ sale.phone.phone_model }} {{ sale.phone.memory_size }}</div>
                  <div class="sale-time">{{ sale.created_at|date:"H:i" }}</div>
                </div>
                <div class="sale-price usd">${{ sale.sale_price|floatformat:0|intcomma }}</div>
              </div>
              <div class="sale-details">