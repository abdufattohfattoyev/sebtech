{% extends 'base.html' %}
{% load custom_filters %}
{% block page_title %}Yillik Hisobot{% endblock %}

{% block extra_css %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }

/* Header */
.header {
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: white;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
.header h1 { font-size: 24px; margin-bottom: 8px; font-weight: 700; }
.header-subtitle { font-size: 14px; opacity: 0.95; }
.nav { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
.nav a {
  padding: 10px 18px;
  background: rgba(255,255,255,0.15);
  border-radius: 8px;
  color: white;
  text-decoration: none;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}
.nav a:hover { background: rgba(255,255,255,0.25); }
.nav a.active { background: rgba(255,255,255,0.35); }

/* Filter */
.filter {
  background: white;
  padding: 18px;
  border-radius: 12px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.filter-row {
  display: grid;
  grid-template-columns: 2fr 1fr auto;
  gap: 12px;
  align-items: end;
}
.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  margin-bottom: 6px;
  color: #374151;
}
.form-select {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 14px;
  transition: border 0.2s;
}
.form-select:focus {
  outline: none;
  border-color: #f59e0b;
}
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary { background: #f59e0b; color: white; }
.btn-primary:hover { background: #d97706; }

/* Charts Grid */
.charts-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
.chart-section {
  background: white;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.chart-section.full-width {
  grid-column: 1 / -1;
}
.chart-title {
  font-size: 16px;
  font-weight: 700;
  color: #111827;
  margin-bottom: 20px;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.chart-container {
  height: 400px;
}
.chart-container.tall {
  height: 500px;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}
.stat-card {
  background: white;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-top: 4px solid;
}
.stat-card.phone { border-top-color: #10b981; }
.stat-card.accessory { border-top-color: #3b82f6; }
.stat-card.exchange { border-top-color: #ef4444; }
.stat-card.profit { border-top-color: #8b5cf6; }
.stat-label {
  font-size: 12px;
  color: #6b7280;
  font-weight: 600;
  text-transform: uppercase;
  margin-bottom: 10px;
}
.stat-value {
  font-size: 28px;
  font-weight: 700;
  margin-bottom: 5px;
}
.stat-value.green { color: #10b981; }
.stat-value.blue { color: #3b82f6; }
.stat-value.red { color: #ef4444; }
.stat-value.purple { color: #8b5cf6; }
.stat-subtitle {
  font-size: 11px;
  color: #9ca3af;
}

/* Detailed Stats Container */
.detailed-stats {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin-bottom: 20px;
}
.stats-section {
  background: white;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.stats-section-title {
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 3px solid;
}
.stats-section-title.usd { border-color: #10b981; color: #10b981; }
.stats-section-title.uzs { border-color: #3b82f6; color: #3b82f6; }

.stats-inner-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
}
.stat-box {
  text-align: center;
  padding: 15px;
  background: linear-gradient(135deg, #f9fafb, #ffffff);
  border-radius: 10px;
  border: 1px solid #e5e7eb;
}
.stat-box-label {
  font-size: 11px;
  color: #6b7280;
  margin-bottom: 8px;
  font-weight: 600;
  text-transform: uppercase;
}
.stat-box-value {
  font-size: 22px;
  font-weight: 700;
  margin-bottom: 5px;
}
.stat-box-value.usd { color: #10b981; }
.stat-box-value.uzs { color: #3b82f6; }
.stat-box-currency {
  font-size: 10px;
  color: #9ca3af;
}

/* JAMI FOYDA CARD */
.total-profit-box {
  grid-column: span 2;
  background: linear-gradient(135deg, #d1fae5, #a7f3d0);
  border: 3px solid #10b981;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}
.total-profit-box .stat-box-label {
  font-size: 13px;
  font-weight: 700;
  color: #065f46;
}
.total-profit-box .stat-box-value {
  font-size: 32px;
  color: #065f46;
}
.total-profit-box .stat-box-currency {
  font-size: 11px;
  color: #059669;
}

/* Tables */
.table-section {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  margin-bottom: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}
.table-header {
  padding: 20px 25px;
  background: linear-gradient(135deg, #f8fafc, #f1f5f9);
  border-bottom: 2px solid #e5e7eb;
  font-weight: 700;
  font-size: 16px;
  color: #111827;
}
.table-responsive {
  overflow-x: auto;
}
.table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}
.table th {
  background: #f9fafb;
  padding: 12px 10px;
  text-align: left;
  font-weight: 600;
  font-size: 11px;
  color: #6b7280;
  text-transform: uppercase;
  border-bottom: 2px solid #e5e7eb;
  white-space: nowrap;
}
.table td {
  padding: 12px 10px;
  border-bottom: 1px solid #f3f4f6;
}
.table tr:hover { background: #f9fafb; }
.table tr:last-child td { border-bottom: none; }
.seller-name {
  font-weight: 600;
  color: #111827;
}
.amount {
  font-weight: 600;
}
.amount.green { color: #10b981; }
.amount.blue { color: #3b82f6; }
.amount.orange { color: #f59e0b; }
.badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  display: inline-block;
  margin-right: 4px;
}
.badge.phone { background: #dcfce7; color: #166534; }
.badge.accessory { background: #dbeafe; color: #1e40af; }
.badge.exchange { background: #fef3c7; color: #92400e; }
.badge.return { background: #fee2e2; color: #991b1b; }

/* Empty State */
.empty {
  text-align: center;
  padding: 60px 20px;
  color: #9ca3af;
  font-size: 14px;
}

/* Responsive */
@media (max-width: 1200px) {
  .charts-grid {
    grid-template-columns: 1fr;
  }
  .chart-container {
    height: 350px;
  }
  .detailed-stats {
    grid-template-columns: 1fr;
  }
}

@media (max-width: 992px) {
  .filter-row {
    grid-template-columns: 1fr 1fr;
  }
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 768px) {
  .container { padding: 15px; }
  .header { padding: 15px; }
  .header h1 { font-size: 20px; }
  .filter-row {
    grid-template-columns: 1fr;
  }
  .stats-grid {
    grid-template-columns: 1fr;
  }
  .chart-container {
    height: 300px;
  }
  .table {
    font-size: 12px;
  }
  .table th,
  .table td {
    padding: 8px 6px;
  }
  .stat-value {
    font-size: 24px;
  }
  .stats-inner-grid {
    grid-template-columns: 1fr;
  }
  .total-profit-box { grid-column: span 1; }
}

@media (max-width: 480px) {
  .header h1 { font-size: 18px; }
  .chart-title { font-size: 14px; }
  .stat-value { font-size: 22px; }
  .table { font-size: 11px; }
  .stat-box-value { font-size: 20px; }
  .chart-container {
    height: 280px;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>{{ selected_shop.name }}</h1>
    <div class="header-subtitle">{{ year }} Yil</div>
    <div class="nav">
      <a href="{% url 'reports:daily' %}?shop={{ selected_shop.id }}">Kunlik</a>
      <a href="{% url 'reports:monthly' %}?shop={{ selected_shop.id }}">Oylik</a>
      <a href="{% url 'reports:yearly' %}?shop={{ selected_shop.id }}" class="active">Yillik</a>
    </div>
  </div>

  <!-- Filter -->
  <div class="filter">
    <form method="get">
      <div class="filter-row">
        <div class="form-group">
          <label>Do'kon</label>
          <select name="shop" class="form-select">
            {% for shop in shops %}
            <option value="{{ shop.id }}" {% if shop == selected_shop %}selected{% endif %}>{{ shop.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Yil</label>
          <select name="year" class="form-select">
            {% for y in years %}
            <option value="{{ y }}" {% if y == year %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Ko'rsat</button>
      </div>
    </form>
  </div>

  <!-- UMUMIY STATISTIKA -->
  <div class="stats-grid">
    <div class="stat-card phone">
      <div class="stat-label">Telefon (Sof)</div>
      <div class="stat-value green">{{ yearly_stats.counts.net_phone|default:0 }}</div>
      <div class="stat-subtitle">sotildi</div>
    </div>
    <div class="stat-card accessory">
      <div class="stat-label">Aksessuar</div>
      <div class="stat-value blue">{{ yearly_stats.counts.accessory|default:0 }}</div>
      <div class="stat-subtitle">sotildi</div>
    </div>
    <div class="stat-card exchange">
      <div class="stat-label">Qaytarildi</div>
      <div class="stat-value red">{{ yearly_stats.counts.returns|default:0 }}</div>
      <div class="stat-subtitle">dona</div>
    </div>
    <div class="stat-card profit">
      <div class="stat-label">Tel+Alm Foyda</div>
      <div class="stat-value purple">${{ yearly_stats.profits.total_phone_exchange_profit|floatformat:0|default:"0" }}</div>
      <div class="stat-subtitle">USD</div>
    </div>
  </div>

  <!-- TELEFON VA AKSESSUAR TAFSILOTI -->
  <div class="detailed-stats">
    <div class="stats-section">
      <div class="stats-section-title usd">TELEFON + ALMASHTIRISH (Dollar)</div>
      <div class="stats-inner-grid">
        <div class="stat-box">
          <div class="stat-box-label">Savdo</div>
          <div class="stat-box-value usd">${{ yearly_stats.totals.phone_sales|floatformat:0|default:"0" }}</div>
          <div class="stat-box-currency">USD</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Naqd</div>
          <div class="stat-box-value usd">${{ yearly_stats.totals.phone_cash|floatformat:0|default:"0" }}</div>
          <div class="stat-box-currency">USD</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Sotilgan</div>
          <div class="stat-box-value usd">{{ yearly_stats.counts.phone|default:0 }}</div>
          <div class="stat-box-currency">dona</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Almashtirish</div>
          <div class="stat-box-value usd">{{ yearly_stats.counts.exchange|default:0 }}</div>
          <div class="stat-box-currency">dona</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Qaytarildi</div>
          <div class="stat-box-value" style="color: #ef4444;">{{ yearly_stats.counts.returns|default:0 }}</div>
          <div class="stat-box-currency">dona</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Sof Telefon</div>
          <div class="stat-box-value usd">{{ yearly_stats.counts.net_phone|default:0 }}</div>
          <div class="stat-box-currency">dona</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Tel. Foyda</div>
          <div class="stat-box-value usd">${{ yearly_stats.profits.phone_profit|floatformat:0|default:"0" }}</div>
          <div class="stat-box-currency">USD</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Alm. Foyda</div>
          <div class="stat-box-value usd">${{ yearly_stats.profits.exchange_profit|floatformat:0|default:"0" }}</div>
          <div class="stat-box-currency">USD</div>
        </div>

        <!-- JAMI FOYDA -->
        <div class="stat-box total-profit-box">
          <div class="stat-box-label">JAMI FOYDA (Tel + Alm)</div>
          <div class="stat-box-value">${{ yearly_stats.profits.total_phone_exchange_profit|floatformat:0|default:"0" }}</div>
          <div class="stat-box-currency">USD</div>
        </div>
      </div>
    </div>

    <div class="stats-section">
      <div class="stats-section-title uzs">AKSESSUAR (So'm)</div>
      <div class="stats-inner-grid">
        <div class="stat-box">
          <div class="stat-box-label">Savdo</div>
          <div class="stat-box-value uzs">{{ yearly_stats.totals.accessory_sales|floatformat:0|default:"0" }}</div>
          <div class="stat-box-currency">UZS</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Naqd</div>
          <div class="stat-box-value uzs">{{ yearly_stats.totals.accessory_cash|floatformat:0|default:"0" }}</div>
          <div class="stat-box-currency">UZS</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Soni</div>
          <div class="stat-box-value uzs">{{ yearly_stats.counts.accessory|default:0 }}</div>
          <div class="stat-box-currency">dona</div>
        </div>
        <div class="stat-box">
          <div class="stat-box-label">Foyda</div>
          <div class="stat-box-value uzs">{{ yearly_stats.profits.accessory_profit|floatformat:0|default:"0" }}</div>
          <div class="stat-box-currency">UZS</div>
        </div>
      </div>
    </div>
  </div>

  <!-- DIAGRAMMALAR -->
  <div class="charts-grid">
    <!-- OYLIK GISTOGRAMMA -->
    <div class="chart-section">
      <div class="chart-title">Oylik Savdolar (Sof Soni)</div>
      <div class="chart-container">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>

    <!-- SOTUVCHILAR YILLIK GISTOGRAMMA -->
    <div class="chart-section">
      <div class="chart-title">Sotuvchilar Reytingi</div>
      <div class="chart-container">
        <canvas id="sellersYearlyChart"></canvas>
      </div>
    </div>

    <!-- SOTUVCHILAR OYLIK TAFSILOTI - YANGI DIAGRAMMA -->
    <div class="chart-section full-width">
      <div class="chart-title">Sotuvchilar Oylik Tafsiloti (Sof Telefon va Aksessuar)</div>
      <div class="chart-container tall">
        <canvas id="sellersMonthlyChart"></canvas>
      </div>
    </div>
  </div>

  <!-- SOTUVCHILAR JADVALI -->
  <div class="table-section">
    <div class="table-header">Sotuvchilar Yillik Tafsiloti ({{ yearly_sellers_stats|length }})</div>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>#</th>
            <th>Sotuvchi</th>
            <th>Sot.</th>
            <th>Alm.</th>
            <th>Qayt.</th>
            <th>Sof Tel.</th>
            <th>Aks.</th>
            <th>Tel.Foyda ($)</th>
            <th>Alm.Foyda ($)</th>
            <th>Tel+Alm ($)</th>
            <th>Aks.Foyda (so'm)</th>
            <th>Kunlar</th>
          </tr>
        </thead>
        <tbody>
          {% for seller in yearly_sellers_stats %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td class="seller-name">{{ seller.seller.get_full_name|default:seller.seller.username }}</td>
            <td>
              <span class="badge phone">{{ seller.phone_count|default:0 }}</span>
            </td>
            <td>
              <span class="badge exchange">{{ seller.exchange_count|default:0 }}</span>
            </td>
            <td>
              <span class="badge return">{{ seller.returns_count|default:0 }}</span>
            </td>
            <td>
              <span class="badge phone">{{ seller.net_phone_count|default:0 }}</span>
            </td>
            <td>
              <span class="badge accessory">{{ seller.accessory_count|default:0 }}</span>
            </td>
            <td class="amount green">${{ seller.phone_profit|floatformat:0|default:"0" }}</td>
            <td class="amount orange">${{ seller.exchange_profit|floatformat:0|default:"0" }}</td>
            <td class="amount green" style="font-weight: 700; font-size: 14px; background: #ecfdf5;">${{ seller.total_phone_exchange_profit|floatformat:0|default:"0" }}</td>
            <td class="amount blue">{{ seller.accessory_profit|floatformat:0|default:"0" }}</td>
            <td>{{ seller.working_days|default:0 }}</td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="12" class="empty">Ma'lumot yo'q</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- OYLIK TAFSILOT JADVALI -->
  <div class="table-section">
    <div class="table-header">Oylik Tafsilot</div>
    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>Oy</th>
            <th>Sot.</th>
            <th>Alm.</th>
            <th>Qayt.</th>
            <th>Sof Tel.</th>
            <th>Aks.</th>
            <th>Tel.Foyda ($)</th>
            <th>Alm.Foyda ($)</th>
            <th>Tel+Alm ($)</th>
            <th>Aks.Foyda (so'm)</th>
            <th>Kunlar</th>
          </tr>
        </thead>
        <tbody>
          {% for monthly in yearly_stats.monthly_stats %}
          <tr>
            <td style="font-weight: 600;">{{ month_names|get_item:monthly.month|default:monthly.month }}-oy</td>
            <td><span class="badge phone">{{ monthly.counts.phone|default:0 }}</span></td>
            <td><span class="badge exchange">{{ monthly.counts.exchange|default:0 }}</span></td>
            <td><span class="badge return">{{ monthly.counts.returns|default:0 }}</span></td>
            <td><span class="badge phone">{{ monthly.counts.net_phone|default:0 }}</span></td>
            <td><span class="badge accessory">{{ monthly.counts.accessory|default:0 }}</span></td>
            <td class="amount green">${{ monthly.profits.phone_profit|floatformat:0|default:"0" }}</td>
            <td class="amount orange">${{ monthly.profits.exchange_profit|floatformat:0|default:"0" }}</td>
            <td class="amount green" style="font-weight: 700; background: #ecfdf5;">${{ monthly.profits.total_phone_exchange_profit|floatformat:0|default:"0" }}</td>
            <td class="amount blue">{{ monthly.profits.accessory_profit|floatformat:0|default:"0" }}</td>
            <td>{{ monthly.period.working_days|default:0 }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// OYLIK GISTOGRAMMA (FAQAT SOF TELEFON VA AKSESSUAR)
const monthlyData = {
  labels: [
    {% for m in yearly_stats.monthly_stats %}
    '{{ month_names|get_item:m.month|default:m.month }}',
    {% endfor %}
  ],
  datasets: [
    {
      label: 'Sof Telefonlar',
      data: [{% for m in yearly_stats.monthly_stats %}{{ m.counts.net_phone|default:0 }},{% endfor %}],
      backgroundColor: '#10b981',
      borderColor: '#059669',
      borderWidth: 2
    },
    {
      label: 'Aksessuarlar',
      data: [{% for m in yearly_stats.monthly_stats %}{{ m.counts.accessory|default:0 }},{% endfor %}],
      backgroundColor: '#3b82f6',
      borderColor: '#2563eb',
      borderWidth: 2
    }
  ]
};

new Chart(document.getElementById('monthlyChart'), {
  type: 'bar',
  data: monthlyData,
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
        labels: { boxWidth: 12, padding: 8, font: { size: 10 } }
      },
      tooltip: {
        callbacks: {
          label: (context) => `${context.dataset.label}: ${context.parsed.y} dona`
        }
      }
    },
    scales: {
      x: { stacked: false },
      y: {
        beginAtZero: true,
        stacked: false,
        ticks: { stepSize: 10 }
      }
    }
  }
});

// SOTUVCHILAR YILLIK GISTOGRAMMA
const sellersData = {
  labels: [
    {% for seller in yearly_sellers_stats %}
    '{{ seller.seller.get_full_name|default:seller.seller.username }}'.substring(0, 10),
    {% endfor %}
  ],
  datasets: [
    {
      label: 'Sof Tel',
      data: [{% for seller in yearly_sellers_stats %}{{ seller.net_phone_count|default:0 }},{% endfor %}],
      backgroundColor: '#10b981',
      borderColor: '#059669',
      borderWidth: 2
    },
    {
      label: 'Aks',
      data: [{% for seller in yearly_sellers_stats %}{{ seller.accessory_count|default:0 }},{% endfor %}],
      backgroundColor: '#3b82f6',
      borderColor: '#2563eb',
      borderWidth: 2
    }
  ]
};

new Chart(document.getElementById('sellersYearlyChart'), {
  type: 'bar',
  data: sellersData,
  options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        position: 'top',
        labels: { boxWidth: 12, padding: 6, font: { size: 10 } }
      },
      tooltip: {
        callbacks: {
          label: (context) => `${context.dataset.label}: ${context.parsed.y} dona`
        }
      }
    },
    scales: {
      x: {