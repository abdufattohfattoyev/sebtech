{% extends "base.html" %}

{% block page_title %}{{ phone.phone_model }} {{ phone.memory_size }}{% endblock %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block extra_css %}
<style>
/* ========== GLOBAL ========== */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
  background: #f8fafc;
  color: #1e293b;
  line-height: 1.6;
}
.container { max-width: 1200px; margin: 0 auto; padding: 1.5rem; }

/* ========== HEADER ========== */
.phone-header {
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  border-radius: 16px;
  color: white;
  padding: 2rem;
  margin-bottom: 1.5rem;
  box-shadow: 0 10px 25px rgba(99, 102, 241, 0.15);
}
.phone-title {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 0.5rem;
  letter-spacing: -0.5px;
}
.phone-imei {
  font-size: 0.95rem;
  opacity: 0.95;
  font-weight: 500;
  margin-bottom: 1rem;
  font-family: 'Courier New', monospace;
}
.status-badge {
  padding: 0.5rem 1rem;
  border-radius: 100px;
  font-weight: 600;
  font-size: 0.85rem;
  display: inline-block;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(10px);
}
.action-buttons {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  margin-top: 1.25rem;
}
.btn-action {
  background: rgba(255,255,255,0.15);
  border: 1px solid rgba(255,255,255,0.2);
  color: white;
  border-radius: 10px;
  padding: 0.65rem 1.25rem;
  font-size: 0.9rem;
  font-weight: 600;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.2s;
  backdrop-filter: blur(10px);
}
.btn-action:hover {
  background: rgba(255,255,255,0.25);
  transform: translateY(-2px);
  color: white;
  box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}

/* ========== LAYOUT ========== */
.main-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1.5rem;
  margin-bottom: 1.5rem;
}

/* ========== CARD ========== */
.card {
  background: white;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 2px 10px rgba(0,0,0,0.04);
  border: 1px solid #e2e8f0;
}
.card-header {
  padding: 1.25rem 1.5rem;
  background: linear-gradient(to right, #f8fafc, #f1f5f9);
  border-bottom: 1px solid #e2e8f0;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.card-title {
  font-size: 1rem;
  font-weight: 700;
  color: #0f172a;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.card-icon {
  font-size: 1.15rem;
  opacity: 0.8;
}
.card-body { padding: 1.5rem; }

/* ========== INFO ROW ========== */
.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.9rem 0;
  border-bottom: 1px solid #f1f5f9;
}
.info-row:last-child { border-bottom: none; }
.info-label {
  font-weight: 600;
  color: #64748b;
  font-size: 0.9rem;
}
.info-value {
  color: #0f172a;
  font-size: 0.95rem;
  font-weight: 500;
  text-align: right;
  max-width: 60%;
  word-wrap: break-word;
}

/* ========== COLORS ========== */
.text-success { color: #10b981; font-weight: 700; }
.text-danger { color: #ef4444; font-weight: 700; }
.text-warning { color: #f59e0b; font-weight: 700; }
.text-primary { color: #3b82f6; font-weight: 700; }
.text-purple { color: #8b5cf6; font-weight: 700; }
.text-muted { color: #94a3b8; }

/* ========== BADGE ========== */
.badge {
  padding: 0.35rem 0.75rem;
  border-radius: 100px;
  font-size: 0.8rem;
  font-weight: 600;
  display: inline-block;
}
.badge-success { background: #dcfce7; color: #166534; }
.badge-danger { background: #fee2e2; color: #991b1b; }
.badge-warning { background: #fef3c7; color: #92400e; }
.badge-info { background: #dbeafe; color: #1e40af; }
.badge-purple { background: #f3e8ff; color: #6b21a8; }

/* ========== PHONE IMAGE ========== */
.phone-image-card {
  text-align: center;
  padding: 2rem;
}
.phone-image {
  width: 100%;
  max-width: 280px;
  height: auto;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  margin: 0 auto;
  display: block;
}

/* ========== DEBT CARD ========== */
.debt-card {
  background: linear-gradient(135deg, #fef2f2, #ffffff);
  border-left: 4px solid #ef4444;
  padding: 1.25rem;
  margin-bottom: 1rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(239, 68, 68, 0.08);
}
.debt-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}
.debt-amount {
  font-weight: 700;
  color: #dc2626;
  font-size: 1.25rem;
}
.debt-remaining {
  font-weight: 700;
  color: #991b1b;
  font-size: 1.1rem;
}
.debt-meta {
  font-size: 0.85rem;
  color: #6b7280;
}
.debt-payments {
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #fecaca;
}
.payment-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  font-size: 0.875rem;
}
.payment-amount { color: #16a34a; font-weight: 600; }
.payment-date { color: #6b7280; }

/* ========== TIMELINE ========== */
.timeline-item {
  padding: 1.25rem;
  border-left: 3px solid #e2e8f0;
  margin-left: 1rem;
  position: relative;
  transition: all 0.2s;
}
.timeline-item:hover {
  background: #f8fafc;
  border-left-color: #6366f1;
}
.timeline-item::before {
  content: '';
  position: absolute;
  left: -7px;
  top: 1.5rem;
  width: 11px;
  height: 11px;
  border-radius: 50%;
  background: #94a3b8;
  border: 2px solid white;
}
.timeline-item.created::before { background: #10b981; }
.timeline-item.sold::before { background: #3b82f6; }
.timeline-item.returned::before { background: #f59e0b; }
.timeline-item.exchanged_new::before { background: #8b5cf6; }
.timeline-item.exchanged_old::before { background: #06b6d4; }

.timeline-event {
  font-weight: 700;
  font-size: 0.95rem;
  color: #0f172a;
  margin-bottom: 0.4rem;
}
.timeline-desc {
  font-size: 0.875rem;
  color: #475569;
  line-height: 1.5;
  margin-bottom: 0.4rem;
}
.timeline-meta {
  font-size: 0.8rem;
  color: #94a3b8;
  display: flex;
  justify-content: space-between;
  margin-top: 0.5rem;
}

/* ========== FINANCIAL HIGHLIGHT ========== */
.financial-highlight {
  background: linear-gradient(135deg, #ecfdf5, #d1fae5);
  border: 2px solid #10b981;
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
  margin-bottom: 1rem;
}
.financial-highlight-label {
  font-size: 0.9rem;
  font-weight: 600;
  color: #065f46;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.financial-highlight-value {
  font-size: 2rem;
  font-weight: 800;
  color: #047857;
}

/* ========== EMPTY STATE ========== */
.empty-state {
  text-align: center;
  padding: 3rem 1.5rem;
  color: #94a3b8;
}
.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.4;
}
.empty-state-text {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
}
.empty-state-desc {
  font-size: 0.875rem;
  color: #cbd5e1;
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  .container { padding: 1rem; }
  .main-grid { grid-template-columns: 1fr; }
  .phone-title { font-size: 1.5rem; }
  .phone-header { padding: 1.5rem; }
  .info-value { max-width: 55%; font-size: 0.875rem; }
  .card-body { padding: 1rem; }
}

/* ========== PRINT ========== */
@media print {
  .action-buttons { display: none; }
  .card { page-break-inside: avoid; }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- ========== HEADER ========== -->
  <div class="phone-header">
    <div class="phone-title">{{ phone.phone_model }} {{ phone.memory_size }}</div>
    <div class="phone-imei">IMEI: {{ phone.imei|default:"N/A" }}</div>
    <span class="status-badge">{{ phone.get_status_display }}</span>

    <div class="action-buttons">
      <a href="{% url 'inventory:phone_list' %}" class="btn-action">
        <i class="fas fa-arrow-left"></i> Orqaga
      </a>
      {% if can_edit %}
      <a href="{% url 'inventory:phone_update' phone.pk %}" class="btn-action">
        <i class="fas fa-edit"></i> Tahrirlash
      </a>
      {% endif %}
    </div>
  </div>

  <div class="main-grid">
    <!-- ========== LEFT COLUMN ========== -->
    <div>
      <!-- ASOSIY MA'LUMOTLAR -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-info-circle card-icon text-primary"></i>
            Asosiy Ma'lumotlar
          </h3>
        </div>
        <div class="card-body">
          <div class="info-row">
            <span class="info-label">Model</span>
            <span class="info-value">{{ phone.phone_model }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Xotira</span>
            <span class="info-value">{{ phone.memory_size }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Holat</span>
            <span class="info-value">{{ phone.condition_percentage }}%</span>
          </div>
          <div class="info-row">
            <span class="info-label">Do'kon</span>
            <span class="info-value">{{ phone.shop.name }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Status</span>
            <span class="info-value">
              <span class="badge
                {% if phone.status == 'shop' %}badge-success
                {% elif phone.status == 'sold' %}badge-info
                {% elif phone.status == 'returned' %}badge-warning
                {% elif phone.status == 'master' %}badge-danger
                {% elif phone.status == 'exchanged_in' %}badge-purple
                {% endif %}">
                {{ phone.get_status_display }}
              </span>
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Qo'shilgan</span>
            <span class="info-value">{{ phone.created_at|date:"d.m.Y" }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Manba</span>
            <span class="info-value">{{ phone.get_source_type_display }}</span>
          </div>
          {% if phone.note %}
          <div class="info-row">
            <span class="info-label">Izoh</span>
            <span class="info-value">{{ phone.note }}</span>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- MOLIYAVIY MA'LUMOTLAR -->
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-dollar-sign card-icon text-success"></i>
            Moliyaviy
          </h3>
        </div>
        <div class="card-body">
          <div class="info-row">
            <span class="info-label">Tan narx (jami)</span>
            <span class="info-value text-danger">${{ phone.cost_price }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">└─ Sotib olish</span>
            <span class="info-value text-muted">${{ phone.purchase_price }}</span>
          </div>
          {% if phone.imei_cost > 0 %}
          <div class="info-row">
            <span class="info-label">└─ IMEI</span>
            <span class="info-value text-muted">${{ phone.imei_cost }}</span>
          </div>
          {% endif %}
          {% if phone.repair_cost > 0 %}
          <div class="info-row">
            <span class="info-label">└─ Ta'mirlash</span>
            <span class="info-value text-muted">${{ phone.repair_cost }}</span>
          </div>
          {% endif %}

          {% if financial_summary.sale_price > 0 %}
          <div class="info-row" style="border-top: 2px solid #e2e8f0; margin-top: 0.75rem; padding-top: 1rem;">
            <span class="info-label">Sotilgan narx</span>
            <span class="info-value text-success">${{ financial_summary.sale_price }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Foyda</span>
            <span class="info-value {% if financial_summary.profit >= 0 %}text-success{% else %}text-danger{% endif %}">
              ${{ financial_summary.profit }}
            </span>
          </div>
          {% if financial_summary.return_amount > 0 %}
          <div class="info-row">
            <span class="info-label">Qaytarilgan</span>
            <span class="info-value text-warning">-${{ financial_summary.return_amount }}</span>
          </div>
          <div class="info-row" style="border-top: 2px solid #10b981; padding-top: 1rem; margin-top: 0.75rem;">
            <span class="info-label" style="font-weight: 700; color: #065f46;">YAKUNIY FOYDA</span>
            <span class="info-value {% if financial_summary.final_profit >= 0 %}text-success{% else %}text-danger{% endif %}" style="font-size: 1.25rem;">
              ${{ financial_summary.final_profit }}
            </span>
          </div>
          {% endif %}
          {% else %}
          <div class="empty-state">
            <i class="fas fa-store"></i>
            <div class="empty-state-text">Hali sotilmagan</div>
            <div class="empty-state-desc">Moliyaviy ma'lumotlar sotilgandan keyin</div>
          </div>
          {% endif %}
        </div>
      </div>

      <!-- SOTISH MA'LUMOTLARI -->
      {% if actual_sale_info %}
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-shopping-cart card-icon text-success"></i>
            {% if actual_sale_info.type == 'phone_sale' %}
              Sotish Ma'lumotlari
            {% else %}
              Almashtirish orqali Sotildi
            {% endif %}
          </h3>
        </div>
        <div class="card-body">
          <div class="info-row">
            <span class="info-label">Sotuvchi</span>
            <span class="info-value">{{ actual_sale_info.salesman.get_full_name|default:actual_sale_info.salesman.username }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Mijoz</span>
            <span class="info-value">
              {% if actual_sale_info.customer %}
                {{ actual_sale_info.customer.name }}
              {% else %}
                {{ actual_sale_info.customer_name }}
              {% endif %}
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Telefon</span>
            <span class="info-value">
              {% if actual_sale_info.customer %}
                {{ actual_sale_info.customer.phone_number }}
              {% else %}
                {{ actual_sale_info.customer_phone }}
              {% endif %}
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Sana</span>
            <span class="info-value">{{ actual_sale_info.sale_date|date:"d.m.Y" }}</span>
          </div>

          {% if actual_sale_info.type == 'phone_exchange' %}
          <div class="info-row" style="border-top: 2px solid #f1f5f9; margin-top: 0.75rem; padding-top: 1rem;">
            <span class="info-label">Eski telefon</span>
            <span class="info-value">{{ actual_sale_info.old_phone_model }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Eski qiymati</span>
            <span class="info-value text-muted">${{ actual_sale_info.old_phone_accepted_price }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Narx farqi</span>
            <span class="info-value {% if actual_sale_info.price_difference > 0 %}text-success{% elif actual_sale_info.price_difference < 0 %}text-danger{% else %}text-muted{% endif %}">
              ${{ actual_sale_info.price_difference }}
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Turi</span>
            <span class="info-value">
              <span class="badge
                {% if actual_sale_info.exchange_type == 'customer_pays' %}badge-success
                {% elif actual_sale_info.exchange_type == 'shop_pays' %}badge-danger
                {% else %}badge-info{% endif %}">
                {% if actual_sale_info.exchange_type == 'customer_pays' %}Mijoz to'laydi
                {% elif actual_sale_info.exchange_type == 'shop_pays' %}Do'kon to'laydi
                {% else %}Teng{% endif %}
              </span>
            </span>
          </div>
          {% endif %}

          <div class="info-row" style="border-top: 2px solid #f1f5f9; margin-top: 0.75rem; padding-top: 1rem;">
            <span class="info-label">Narx</span>
            <span class="info-value text-success" style="font-size: 1.15rem;">${{ actual_sale_info.sale_price }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Naqd</span>
            <span class="info-value">${{ actual_sale_info.cash_amount }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Karta</span>
            <span class="info-value">${{ actual_sale_info.card_amount }}</span>
          </div>
          {% if actual_sale_info.credit_amount > 0 %}
          <div class="info-row">
            <span class="info-label">Nasiya</span>
            <span class="info-value text-warning">${{ actual_sale_info.credit_amount }}</span>
          </div>
          {% endif %}
          {% if actual_sale_info.debt_amount > 0 %}
          <div class="info-row">
            <span class="info-label">Qarz</span>
            <span class="info-value text-danger">${{ actual_sale_info.debt_amount }}</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- QAYTARISH -->
      {% if phone_return %}
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-undo card-icon text-warning"></i>
            Qaytarilgan
          </h3>
        </div>
        <div class="card-body">
          <div class="info-row">
            <span class="info-label">Sana</span>
            <span class="info-value">{{ phone_return.return_date|date:"d.m.Y" }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Summa</span>
            <span class="info-value text-warning">${{ phone_return.return_amount }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Sabab</span>
            <span class="info-value">{{ phone_return.reason|truncatechars:50 }}</span>
          </div>
          {% if phone_return.notes %}
          <div class="info-row">
            <span class="info-label">Izoh</span>
            <span class="info-value">{{ phone_return.notes }}</span>
          </div>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- QARZLAR -->
      {% if customer_debts %}
      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-credit-card card-icon text-danger"></i>
            Mijoz qarzlari ({{ customer_debts|length }})
          </h3>
        </div>
        <div class="card-body">
          {% for debt in customer_debts %}
          <div class="debt-card">
            <div class="debt-header">
              <div>
                <div class="debt-amount">${{ debt.debt_amount }}</div>
                <div class="debt-meta">{{ debt.created_at|date:"d.m.Y" }}</div>
              </div>
              <div style="text-align: right;">
                <div class="debt-remaining">Qoldiq: ${{ debt.remaining_amount }}</div>
                <div class="debt-meta">{{ debt.payment_percentage|floatformat:0 }}% to'langan</div>
              </div>
            </div>

            {% if debt.payments.exists %}
            <div class="debt-payments">
              <div style="font-size: 0.85rem; font-weight: 600; color: #6b7280; margin-bottom: 0.5rem;">To'lovlar:</div>
              {% for payment in debt.payments.all|slice:":3" %}
              <div class="payment-item">
                <span class="payment-amount">${{ payment.payment_amount }}</span>
                <span class="payment-date">{{ payment.payment_date|date:"d.m.Y" }}</span>
              </div>
              {% endfor %}
              {% if debt.payments.count > 3 %}
              <div style="font-size: 0.8rem; color: #94a3b8; margin-top: 0.5rem;">
                +{{ debt.payments.count|add:"-3" }} ta yana...
              </div>
              {% endif %}
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>

    <!-- ========== RIGHT COLUMN ========== -->
    <div>
      <!-- RASM -->
      {% if phone.image %}
      <div class="card">
        <div class="phone-image-card">
          <img src="{{ phone.image.url }}" alt="{{ phone }}" class="phone-image">
        </div>
      </div>
      {% endif %}

      <!-- TIMELINE -->
      <div class="card" style="{% if phone.image %}margin-top: 1.5rem;{% endif %}">
        <div class="card-header">
          <h3 class="card-title">
            <i class="fas fa-history card-icon text-info"></i>
            Tarix
          </h3>
        </div>
        <div class="card-body" style="padding: 0;">
          {% for event in timeline %}
          <div class="timeline-item {{ event.type }}">
            <div class="timeline-event">{{ event.event }}</div>
            <div class="timeline-desc">{{ event.description }}</div>
            <div class="timeline-meta">
              <span>{{ event.user.username|default:"Tizim" }}</span>
              <span>{{ event.date|date:"d.m.Y" }}</span>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}