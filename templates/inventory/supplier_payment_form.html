{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Tahrirlash{% else %}To'lov{% endif %} - {{ supplier.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-9 col-xl-8">
            <!-- üéØ HEADER -->
            <div class="header-card mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="header-badge mb-2">
                            {% if is_edit %}
                            <i class="fas fa-edit"></i> Tahrirlash
                            {% else %}
                            <i class="fas fa-plus-circle"></i> Yangi To'lov
                            {% endif %}
                        </div>
                        <h2 class="header-title">{{ supplier.name }}</h2>
                    </div>
                    <a href="{% url 'inventory:supplier_detail' supplier.id %}" class="btn-icon">
                        <i class="fas fa-arrow-left"></i>
                    </a>
                </div>
            </div>

            <!-- üí∞ QARZ DASHBOARD -->
            <div class="stats-grid mb-4">
                <div class="stat-card stat-info">
                    <div class="stat-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Boshlang'ich</span>
                        <span class="stat-value">${{ supplier.initial_debt|floatformat:2 }}</span>
                    </div>
                </div>
                <div class="stat-card stat-warning">
                    <div class="stat-icon">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Telefonlar</span>
                        <span class="stat-value">${{ supplier.total_debt|floatformat:2 }}</span>
                    </div>
                </div>
                <div class="stat-card stat-danger">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <span class="stat-label">Jami Qarz</span>
                        <span class="stat-value">${{ supplier.balance|floatformat:2 }}</span>
                    </div>
                    <div class="stat-pulse"></div>
                </div>
            </div>

            <!-- üìù MAIN FORM -->
            <div class="form-card">
                <form method="post" id="paymentForm">
                    {% csrf_token %}
                    {{ form.supplier }}

                    {% if form.non_field_errors %}
                    <div class="alert-modern alert-danger mb-4">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>{% for error in form.non_field_errors %}{{ error }}{% endfor %}</span>
                    </div>
                    {% endif %}

                    <!-- üè™ DO'KON -->
                    <div class="form-group">
                        <label class="form-label-modern">
                            <i class="fas fa-store"></i>
                            <span>Do'kon</span>
                        </label>
                        {{ form.shop }}
                        {% if form.shop.errors %}
                        <div class="form-error">{{ form.shop.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- üíµ SUMMA & SANA -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label-modern">
                                <i class="fas fa-dollar-sign"></i>
                                <span>Summa ($)</span>
                            </label>
                            {{ form.amount }}
                            {% if form.amount.errors %}
                            <div class="form-error">{{ form.amount.errors.0 }}</div>
                            {% endif %}
                            <div class="form-hint">Maksimal: ${{ supplier.balance|floatformat:2 }}</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label-modern">
                                <i class="fas fa-calendar"></i>
                                <span>Sana</span>
                            </label>
                            {{ form.payment_date }}
                            {% if form.payment_date.errors %}
                            <div class="form-error">{{ form.payment_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- üí≥ TO'LOV MANBASI -->
                    <div class="form-group">
                        <label class="form-label-modern mb-3">
                            <i class="fas fa-wallet"></i>
                            <span>To'lov Manbasi</span>
                        </label>
                        <div class="source-grid">
                            <input type="radio" class="source-input" name="payment_source" id="source_safe" value="safe"
                                   {% if not form.instance.pk or form.instance.payment_source == 'safe' %}checked{% endif %}>
                            <label class="source-card" for="source_safe">
                                <div class="source-icon source-icon-safe">
                                    <i class="fas fa-lock"></i>
                                </div>
                                <div class="source-info">
                                    <strong>Seyf</strong>
                                    <small>Kunlik chiqim emas</small>
                                </div>
                                <div class="source-check">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </label>

                            <input type="radio" class="source-input" name="payment_source" id="source_cash" value="cash"
                                   {% if form.instance.pk and form.instance.payment_source == 'cash' %}checked{% endif %}>
                            <label class="source-card" for="source_cash">
                                <div class="source-icon source-icon-cash">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div class="source-info">
                                    <strong>Kassa</strong>
                                    <small>Kunlik chiqim</small>
                                </div>
                                <div class="source-check">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </label>
                        </div>
                        <div class="alert-modern alert-warning mt-3" id="cashAlert" style="display:none;">
                            <i class="fas fa-info-circle"></i>
                            <span><strong>Diqqat:</strong> Kassadan to'lov kunlik hisobotda chiqim sifatida ko'rsatiladi.</span>
                        </div>
                    </div>

                    <!-- üìã TO'LOV TURI -->
                    <div class="form-group">
                        <label class="form-label-modern mb-3">
                            <i class="fas fa-list"></i>
                            <span>To'lov Turi</span>
                        </label>
                        <div class="type-toggle">
                            {% for radio in form.payment_type %}
                            {{ radio.tag }}
                            <label class="type-option" for="{{ radio.id_for_label }}">
                                <i class="fas fa-{% if radio.choice_value == 'general' %}sort-amount-down{% else %}hand-pointer{% endif %}"></i>
                                <span>{% if radio.choice_value == 'general' %}Umumiy (FIFO){% else %}Maxsus{% endif %}</span>
                            </label>
                            {% endfor %}
                        </div>
                        <div class="form-hint">
                            <i class="fas fa-info-circle"></i>
                            Umumiy: Eng eski qarzlar | Maxsus: Siz tanlaysiz
                        </div>
                    </div>

                    <!-- üì± TELEFONLAR -->
                    <div id="phoneBlock" class="phone-block" style="display:none;">
                        <div class="phone-header">
                            <h6>
                                <i class="fas fa-mobile-alt"></i>
                                Telefonlarni Tanlang
                            </h6>
                        </div>
                        {% if debt_phones %}
                        <div class="phone-table-wrap">
                            <table class="phone-table">
                                <thead>
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" id="selectAll" class="modern-check">
                                        </th>
                                        <th>Model</th>
                                        <th>IMEI</th>
                                        <th class="text-end">Qarz</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for phone in debt_phones %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" name="selected_phones" value="{{ phone.id }}"
                                                   class="modern-check phone-cb" data-debt="{{ phone.debt_balance }}">
                                        </td>
                                        <td>
                                            <div class="phone-model">
                                                <strong>{{ phone.phone_model }}</strong>
                                                <small>{{ phone.memory_size }}</small>
                                            </div>
                                        </td>
                                        <td><code class="phone-imei">{{ phone.imei }}</code></td>
                                        <td class="text-end">
                                            <span class="debt-badge">${{ phone.debt_balance|floatformat:2 }}</span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="phone-stats">
                            <div class="phone-stat">
                                <span class="phone-stat-label">Tanlangan:</span>
                                <span class="phone-stat-value" id="count">0</span>
                            </div>
                            <div class="phone-stat">
                                <span class="phone-stat-label">Qarz:</span>
                                <span class="phone-stat-value debt">$<span id="debt">0.00</span></span>
                            </div>
                        </div>
                        {% else %}
                        <div class="phone-empty">
                            <i class="fas fa-check-circle"></i>
                            <p>Qarzda telefon yo'q</p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- üí¨ IZOH -->
                    <div class="form-group">
                        <label class="form-label-modern">
                            <i class="fas fa-comment"></i>
                            <span>Izoh <small class="text-muted">(ixtiyoriy)</small></span>
                        </label>
                        {{ form.notes }}
                    </div>

                    <!-- üîò ACTIONS -->
                    <div class="form-actions">
                        <a href="{% url 'inventory:supplier_detail' supplier.id %}" class="btn-modern btn-secondary">
                            <i class="fas fa-times"></i>
                            <span>Bekor qilish</span>
                        </a>
                        <button type="submit" class="btn-modern btn-primary">
                            <i class="fas fa-{% if is_edit %}save{% else %}check{% endif %}"></i>
                            <span>{% if is_edit %}Yangilash{% else %}To'lov Qilish{% endif %}</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
:root {
    --primary: #0d6efd;
    --success: #10b981;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --secondary: #6c757d;
    --border-radius: 16px;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
    --shadow-lg: 0 10px 30px rgba(0,0,0,0.12);
}

/* üéØ HEADER */
.header-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 2rem;
    border-radius: var(--border-radius);
    color: white;
    box-shadow: var(--shadow-md);
}

.header-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: rgba(255,255,255,0.2);
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-size: 0.875rem;
    font-weight: 500;
}

.header-title {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 700;
}

.btn-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    transition: all 0.3s;
}

.btn-icon:hover {
    background: rgba(255,255,255,0.3);
    transform: translateX(-4px);
    color: white;
}

/* üí∞ STATS GRID */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.stat-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow-sm);
    transition: all 0.3s;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-4px);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.stat-info .stat-icon {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.stat-warning .stat-icon {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.stat-danger .stat-icon {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.stat-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: #6b7280;
    font-weight: 500;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
}

.stat-danger .stat-value {
    color: var(--danger);
}

.stat-pulse {
    position: absolute;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(239,68,68,0.1) 0%, transparent 70%);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(0.8); opacity: 0.5; }
    50% { transform: scale(1.2); opacity: 0.8; }
}

/* üìù FORM CARD */
.form-card {
    background: white;
    border-radius: var(--border-radius);
    padding: 2rem;
    box-shadow: var(--shadow-sm);
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.form-label-modern {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 0.75rem;
}

.form-label-modern i {
    color: var(--primary);
}

.form-control, .form-select {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
    transition: all 0.3s;
}

.form-control:focus, .form-select:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(13,110,253,0.1);
}

.form-hint {
    font-size: 0.875rem;
    color: #6b7280;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.form-error {
    color: var(--danger);
    font-size: 0.875rem;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

/* üí≥ SOURCE GRID */
.source-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.source-input {
    display: none;
}

.source-card {
    background: white;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1.25rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.source-card:hover {
    border-color: var(--primary);
    box-shadow: var(--shadow-sm);
}

.source-input:checked + .source-card {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(13,110,253,0.05), rgba(13,110,253,0.1));
    box-shadow: var(--shadow-md);
}

.source-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
}

.source-icon-safe {
    background: linear-gradient(135deg, #6c757d, #495057);
    color: white;
}

.source-icon-cash {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
}

.source-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.source-info strong {
    font-size: 1rem;
    color: #111827;
}

.source-info small {
    font-size: 0.875rem;
    color: #6b7280;
}

.source-check {
    color: var(--primary);
    font-size: 1.25rem;
    opacity: 0;
    transition: opacity 0.3s;
}

.source-input:checked + .source-card .source-check {
    opacity: 1;
}

/* üìã TYPE TOGGLE */
.type-toggle {
    display: flex;
    background: #f3f4f6;
    padding: 0.5rem;
    border-radius: 12px;
    gap: 0.5rem;
}

.type-toggle input[type="radio"] {
    display: none;
}

.type-option {
    flex: 1;
    padding: 0.875rem 1rem;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    font-weight: 500;
    color: #6b7280;
}

.type-toggle input[type="radio"]:checked + .type-option {
    background: var(--primary);
    color: white;
    box-shadow: var(--shadow-sm);
}

/* üì± PHONE BLOCK */
.phone-block {
    background: #f9fafb;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.phone-header {
    padding: 1rem 1.5rem;
    background: white;
    border-bottom: 1px solid #e5e7eb;
}

.phone-header h6 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
}

.phone-table-wrap {
    max-height: 350px;
    overflow-y: auto;
}

.phone-table {
    width: 100%;
    border-collapse: collapse;
}

.phone-table thead {
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
}

.phone-table th {
    padding: 0.875rem 1rem;
    text-align: left;
    font-size: 0.875rem;
    font-weight: 600;
    color: #6b7280;
    border-bottom: 1px solid #e5e7eb;
}

.phone-table td {
    padding: 1rem;
    border-bottom: 1px solid #f3f4f6;
}

.phone-table tbody tr:hover {
    background: white;
}

.modern-check {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    cursor: pointer;
}

.phone-model {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.phone-model strong {
    color: #111827;
}

.phone-model small {
    color: #6b7280;
    font-size: 0.875rem;
}

.phone-imei {
    background: #f3f4f6;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.875rem;
    color: #6b7280;
}

.debt-badge {
    background: linear-gradient(135deg, #fef3c7, #fde68a);
    color: #92400e;
    padding: 0.375rem 0.75rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
}

.phone-stats {
    padding: 1rem 1.5rem;
    background: white;
    border-top: 1px solid #e5e7eb;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.phone-stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.phone-stat-label {
    color: #6b7280;
    font-size: 0.875rem;
}

.phone-stat-value {
    background: var(--primary);
    color: white;
    padding: 0.375rem 0.875rem;
    border-radius: 8px;
    font-weight: 600;
}

.phone-stat-value.debt {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.phone-empty {
    padding: 3rem;
    text-align: center;
    color: #9ca3af;
}

.phone-empty i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* üö® ALERT */
.alert-modern {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    border: none;
    animation: slideIn 0.3s ease-out;
}

.alert-danger {
    background: linear-gradient(135deg, #fef2f2, #fee2e2);
    color: #991b1b;
}

.alert-warning {
    background: linear-gradient(135deg, #fffbeb, #fef3c7);
    color: #92400e;
}

.alert-modern i {
    font-size: 1.25rem;
}

/* üîò ACTIONS */
.form-actions {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #e5e7eb;
}

.btn-modern {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1.75rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
}

.btn-secondary {
    background: #f3f4f6;
    color: #374151;
}

.btn-secondary:hover {
    background: #e5e7eb;
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.btn-primary {
    background: linear-gradient(135deg, var(--primary), #0056b3);
    color: white;
    box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* üì± RESPONSIVE */
@media (max-width: 768px) {
    .header-card {
        padding: 1.5rem;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .form-card {
        padding: 1.5rem;
    }

    .source-grid {
        grid-template-columns: 1fr;
    }

    .form-actions {
        flex-direction: column;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const paymentTypeRadios = document.querySelectorAll('input[name="payment_type"]');
    const phoneBlock = document.getElementById('phoneBlock');
    const phoneCheckboxes = document.querySelectorAll('.phone-cb');
    const selectAll = document.getElementById('selectAll');
    const countSpan = document.getElementById('count');
    const debtSpan = document.getElementById('debt');
    const sourceRadios = document.querySelectorAll('input[name="payment_source"]');
    const cashAlert = document.getElementById('cashAlert');

    // Payment Source
    sourceRadios.forEach(radio => {
        radio.addEventListener('change', () => {
            cashAlert.style.display = radio.value === 'cash' ? 'block' : 'none';
        });
    });

    const selected = document.querySelector('input[name="payment_source"]:checked');
    if (selected?.value === 'cash') cashAlert.style.display = 'block';

    // Payment Type
    paymentTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            phoneBlock.style.display = this.value === 'specific' ? 'block' : 'none';
            if (this.value !== 'specific') {
                phoneCheckboxes.forEach(cb => cb.checked = false);
                updateStats();
            }
        });
    });

    const selectedType = document.querySelector('input[name="payment_type"]:checked');
    if (selectedType?.value === 'specific') phoneBlock.style.display = 'block';

    // Select All
    if (selectAll) {
        selectAll.addEventListener('change', function() {
            phoneCheckboxes.forEach(cb => cb.checked = this.checked);
            updateStats();
        });
    }

    // Individual Checkboxes
    phoneCheckboxes.forEach(cb => {
        cb.addEventListener('change', function() {
            updateStats();
            if (!this.checked && selectAll) selectAll.checked = false;
            const allChecked = Array.from(phoneCheckboxes).every(c => c.checked);
            if (allChecked && selectAll) selectAll.checked = true;
        });
    });

    function updateStats() {
        let count = 0, total = 0;
        phoneCheckboxes.forEach(cb => {
            if (cb.checked) {
                count++;
                total += parseFloat(cb.dataset.debt) || 0;
            }
        });
        if (countSpan) countSpan.textContent = count;
        if (debtSpan) debtSpan.textContent = total.toFixed(2);
    }

    updateStats();
});
</script>
{% endblock %}